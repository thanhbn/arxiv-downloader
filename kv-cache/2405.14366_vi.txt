# MiniCache: NÃ©n KV Cache theo Chiá»u SÃ¢u
Dimension cho MÃ´ hÃ¬nh NgÃ´n ngá»¯ Lá»›n

Akide Liu1 Jing Liu1 Zizheng Pan1 Yefei He2
Gholamreza Haffari1 Bohan Zhuang1,2â€ 

1ZIP Lab, Äáº¡i há»c Monash, Australia
2ZIP Lab, Äáº¡i há»c Chiáº¿t Giang, Trung Quá»‘c

## TÃ³m táº¯t

Má»™t phÆ°Æ¡ng phÃ¡p quan trá»ng Ä‘á»ƒ triá»ƒn khai hiá»‡u quáº£ cÃ¡c mÃ´ hÃ¬nh ngÃ´n ngá»¯ lá»›n (LLM) Ä‘Ã²i há»i tÃ­nh toÃ¡n cao lÃ  bá»™ nhá»› Ä‘á»‡m Key-Value (KV). Bá»™ nhá»› Ä‘á»‡m KV lÆ°u trá»¯ cÃ¡c tráº¡ng thÃ¡i key-value cá»§a cÃ¡c token Ä‘Ã£ táº¡o trÆ°á»›c Ä‘Ã³, giáº£m Ä‘Ã¡ng ká»ƒ nhu cáº§u tÃ­nh toÃ¡n láº·p Ä‘i láº·p láº¡i vÃ  tá»« Ä‘Ã³ giáº£m Ä‘á»™ trá»… trong quÃ¡ trÃ¬nh táº¡o tá»± há»“i quy. Tuy nhiÃªn, kÃ­ch thÆ°á»›c cá»§a bá»™ nhá»› Ä‘á»‡m KV tÄƒng tuyáº¿n tÃ­nh theo Ä‘á»™ dÃ i chuá»—i, táº¡o ra thÃ¡ch thá»©c cho cÃ¡c á»©ng dá»¥ng yÃªu cáº§u Ä‘áº§u vÃ o ngá»¯ cáº£nh dÃ i vÃ  táº¡o chuá»—i má»Ÿ rá»™ng. Trong bÃ i bÃ¡o nÃ y, chÃºng tÃ´i trÃ¬nh bÃ y má»™t phÆ°Æ¡ng phÃ¡p Ä‘Æ¡n giáº£n nhÆ°ng hiá»‡u quáº£, Ä‘Æ°á»£c gá»i lÃ  MiniCache, Ä‘á»ƒ nÃ©n bá»™ nhá»› Ä‘á»‡m KV qua cÃ¡c lá»›p tá»« má»™t gÃ³c Ä‘á»™ chiá»u sÃ¢u má»›i, giáº£m Ä‘Ã¡ng ká»ƒ dung lÆ°á»£ng bá»™ nhá»› cho suy luáº­n LLM. PhÆ°Æ¡ng phÃ¡p cá»§a chÃºng tÃ´i dá»±a trÃªn quan sÃ¡t ráº±ng cÃ¡c tráº¡ng thÃ¡i bá»™ nhá»› Ä‘á»‡m KV thá»ƒ hiá»‡n Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng cao giá»¯a cÃ¡c lá»›p liá»n ká» trong pháº§n giá»¯a Ä‘áº¿n sÃ¢u cá»§a LLM. Äá»ƒ táº¡o Ä‘iá»u kiá»‡n cho viá»‡c há»£p nháº¥t, chÃºng tÃ´i Ä‘á» xuáº¥t tÃ¡ch rá»i cÃ¡c tráº¡ng thÃ¡i thÃ nh cÃ¡c thÃ nh pháº§n Ä‘á»™ lá»›n vÃ  hÆ°á»›ng, ná»™i suy cÃ¡c hÆ°á»›ng cá»§a vector tráº¡ng thÃ¡i trong khi giá»¯ nguyÃªn Ä‘á»™ dÃ i cá»§a chÃºng. HÆ¡n ná»¯a, chÃºng tÃ´i giá»›i thiá»‡u má»™t chiáº¿n lÆ°á»£c giá»¯ láº¡i token Ä‘á»ƒ giá»¯ cÃ¡c cáº·p tráº¡ng thÃ¡i khÃ¡c biá»‡t cao khÃ´ng bá»‹ há»£p nháº¥t, do Ä‘Ã³ báº£o tá»“n thÃ´ng tin vá»›i chi phÃ­ lÆ°u trá»¯ bá»• sung tá»‘i thiá»ƒu. MiniCache cá»§a chÃºng tÃ´i khÃ´ng cáº§n huáº¥n luyá»‡n vÃ  cÃ³ tÃ­nh tá»•ng quÃ¡t, bá»• sung cho cÃ¡c chiáº¿n lÆ°á»£c nÃ©n bá»™ nhá»› Ä‘á»‡m KV hiá»‡n cÃ³ nhÆ° lÆ°á»£ng tá»­ hÃ³a vÃ  thÆ°a thá»›t. ChÃºng tÃ´i tiáº¿n hÃ nh Ä‘Ã¡nh giÃ¡ toÃ n diá»‡n vá» MiniCache sá»­ dá»¥ng cÃ¡c mÃ´ hÃ¬nh khÃ¡c nhau bao gá»“m LLaMA-2, LLaMA-3, Phi-3, Mistral vÃ  Mixtral trÃªn nhiá»u benchmark, chá»©ng minh hiá»‡u nÄƒng Ä‘áº·c biá»‡t cá»§a nÃ³ trong viá»‡c Ä‘áº¡t Ä‘Æ°á»£c tá»· lá»‡ nÃ©n vÆ°á»£t trá»™i vÃ  thÃ´ng lÆ°á»£ng cao. TrÃªn bá»™ dá»¯ liá»‡u ShareGPT, LLaMA-2-7B vá»›i MiniCache 4-bit Ä‘áº¡t Ä‘Æ°á»£c tá»· lá»‡ nÃ©n Ä‘Ã¡ng chÃº Ã½ lÃªn Ä‘áº¿n 5.02Ã—, tÄƒng cÆ°á»ng thÃ´ng lÆ°á»£ng suy luáº­n khoáº£ng 5Ã— vÃ  giáº£m dung lÆ°á»£ng bá»™ nhá»› 41% so vá»›i baseline cache Ä‘áº§y Ä‘á»§ FP16, táº¥t cáº£ trong khi duy trÃ¬ hiá»‡u nÄƒng gáº§n nhÆ° khÃ´ng máº¥t mÃ¡t. Dá»± Ã¡n cÃ³ sáºµn táº¡i https://minicache.vmv.re

## 1 Giá»›i thiá»‡u

CÃ¡c MÃ´ hÃ¬nh NgÃ´n ngá»¯ Lá»›n (LLM), Ä‘Æ°á»£c minh há»a bá»Ÿi chuá»—i GPT [1,2,3] vÃ  chuá»—i LLaMA [4,5,6], Ä‘Ã£ ná»•i lÃªn nhÆ° nhá»¯ng Ä‘á»•i má»›i then chá»‘t trong trÃ­ tuá»‡ nhÃ¢n táº¡o tá»•ng quÃ¡t, nÃ¢ng cao Ä‘Ã¡ng ká»ƒ kháº£ nÄƒng xá»­ lÃ½ ngÃ´n ngá»¯ tá»± nhiÃªn. Tuy nhiÃªn, nhá»¯ng mÃ´ hÃ¬nh nÃ y Ä‘Æ°á»£c huáº¥n luyá»‡n tá»‰ má»‰ báº±ng cÃ¡ch sá»­ dá»¥ng tÃ i nguyÃªn tÃ­nh toÃ¡n rá»™ng lá»›n [7] vÃ  bá»™ dá»¯ liá»‡u khá»•ng lá»“ [8], Ä‘iá»u nÃ y cho phÃ©p chÃºng táº¡o ra vÄƒn báº£n mÃ´ phá»ng hiá»‡u quáº£ phong cÃ¡ch viáº¿t cá»§a con ngÆ°á»i vÃ  tiáº¿n hÃ nh phÃ¢n tÃ­ch lÃ½ luáº­n phá»©c táº¡p, nhÆ°ng Ä‘áº·t ra thÃ¡ch thá»©c vá» triá»ƒn khai vÃ  phá»¥c vá»¥ hiá»‡u quáº£. Trong khuÃ´n khá»• suy luáº­n cá»§a

â€ TÃ¡c giáº£ liÃªn há»‡. Email: bohan.zhuang@gmail.com
Preprint. Äang xem xÃ©t.arXiv:2405.14366v2 [cs.CL] 7 Sep 2024

---

(a) Äá»™ tÆ°Æ¡ng Ä‘á»“ng KV cache qua lá»›p
(b) Lá»›p Ä‘Ã£ há»£p nháº¥t vs Ä‘iá»ƒm EM trÃªn GSM8K
(c) So sÃ¡nh giá»¯a MiniCache vÃ  cÃ¡c phÆ°Æ¡ng phÃ¡p trÆ°á»›c Ä‘Ã³

Lá»›p ğ‘™âˆ’1
Lá»›p ğ‘™âˆ’2
...
Lá»›p 2
Lá»›p 1
LMHead
Äáº§u vÃ o
Lá»›p ğ‘™âˆ’3

Pruning/Quant.
KV
KV Cache Compression
T
Decoding

Cross Layer Merging
KV
QKV
Attention

Decoding
KV Cache Compression
QKV
Attention
T+1
Prevs.
MiniCache

Äá»™ tÆ°Æ¡ng Ä‘á»“ng Cosine
T
T+1
Sá»‘ lÆ°á»£ng Lá»›p Ä‘Æ°á»£c Há»£p nháº¥t trÃªn LLaMA-3-70B

**HÃ¬nh 1:** Tá»•ng quan vá» chiáº¿n lÆ°á»£c MiniCache cá»§a chÃºng tÃ´i vÃ  káº¿t quáº£ vÃ­ dá»¥: (a) cho tháº¥y quan sÃ¡t ráº±ng cÃ¡c tráº¡ng thÃ¡i bá»™ nhá»› Ä‘á»‡m KV giá»¯a hai lá»›p liá»n ká» cÃ³ Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng cao, Ä‘áº·c biá»‡t qua cÃ¡c lá»›p giá»¯a Ä‘áº¿n sÃ¢u. Trá»¥c x sá»­ dá»¥ng index/2 Ä‘á»ƒ biá»ƒu diá»…n Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng cho tá»«ng cáº·p lá»›p. (b) so sÃ¡nh hiá»‡u nÄƒng cá»§a MiniCache vÃ  baseline trung bÃ¬nh, Ä‘Æ¡n giáº£n lÃ  tÃ­nh trung bÃ¬nh cÃ¡c bá»™ nhá»› Ä‘á»‡m KV cá»§a hai lá»›p, sá»­ dá»¥ng mÃ´ hÃ¬nh LLaMA-3-70B [6] trÃªn bá»™ dá»¯ liá»‡u GSM8K [10]. MiniCache, báº¯t Ä‘áº§u há»£p nháº¥t tá»« Ä‘á»™ sÃ¢u ná»­a lá»›p, Ä‘áº¡t Ä‘Æ°á»£c hiá»‡u nÄƒng gáº§n nhÆ° khÃ´ng máº¥t mÃ¡t. (c) nÃªu báº­t sá»± khÃ¡c biá»‡t chÃ­nh giá»¯a MiniCache vÃ  cÃ¡c phÆ°Æ¡ng phÃ¡p trÆ°á»›c Ä‘Ã³. MiniCache Ä‘iá»u tra sá»± dÆ° thá»«a giá»¯a cÃ¡c lá»›p cá»§a bá»™ nhá»› Ä‘á»‡m KV dá»c theo chiá»u sÃ¢u cá»§a LLM, má»™t khÃ­a cáº¡nh bá»‹ bá» qua bá»Ÿi cÃ¡c phÆ°Æ¡ng phÃ¡p dá»±a trÃªn intra-layer. á» Ä‘Ã¢y, T Ä‘á» cáº­p Ä‘áº¿n timestamp cuá»‘i cÃ¹ng cá»§a pre-filling, vÃ  T+1 Ä‘á» cáº­p Ä‘áº¿n timestamp Ä‘áº§u tiÃªn cá»§a decoding.

LLM, bá»™ nhá»› Ä‘á»‡m KV [9] ráº¥t quan trá»ng Ä‘á»ƒ lÆ°u trá»¯ cÃ¡c key vÃ  value Ä‘Ã£ tÃ­nh toÃ¡n trÆ°á»›c, do Ä‘Ã³ trÃ¡nh cÃ¡c tÃ­nh toÃ¡n láº·p láº¡i trÃªn ngá»¯ cáº£nh trÆ°á»›c Ä‘Ã³ vÃ  nÃ¢ng cao Ä‘Ã¡ng ká»ƒ hiá»‡u quáº£ triá»ƒn khai LLM. Tuy nhiÃªn, nhu cáº§u tÄƒng cao vá» Ä‘á»™ dÃ i chuá»—i dÃ i hÆ¡n dáº«n Ä‘áº¿n cÃ¡c tráº¡ng thÃ¡i Ä‘Æ°á»£c cache khá»•ng lá»“, gÃ¢y ra tiÃªu thá»¥ bá»™ nhá»› Ä‘Ã¡ng ká»ƒ trong quÃ¡ trÃ¬nh táº¡o. VÃ­ dá»¥, má»™t mÃ´ hÃ¬nh GPT-3 175B [2], vá»›i kÃ­ch thÆ°á»›c batch lÃ  64 vÃ  Ä‘á»™ dÃ i chuá»—i 4,096 token (cáº£ prefilled vÃ  generated), yÃªu cáº§u khoáº£ng 1,208GB bá»™ nhá»› GPU. YÃªu cáº§u nÃ y lá»›n hÆ¡n 3.45Ã— so vá»›i bá»™ nhá»› Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ lÆ°u trá»¯ trá»ng sá»‘ cá»§a mÃ´ hÃ¬nh. Trong bá»‘i cáº£nh nÃ y, nÃ©n bá»™ nhá»› Ä‘á»‡m KV cÃ³ táº§m quan trá»ng hÃ ng Ä‘áº§u do cÃ¡c lá»£i Ã­ch rÃµ rÃ ng cá»§a nÃ³: 1) nÃ³ giáº£m Ä‘Ã¡ng ká»ƒ dung lÆ°á»£ng bá»™ nhá»› cho phÃ©p táº¡o nhanh hÆ¡n vÃ  phá»¥c vá»¥ batch lá»›n hÆ¡n; 2) nÃ³ giáº£m Ä‘Ã¡ng ká»ƒ chi phÃ­ má»—i token, chá»©ng minh lá»£i Ã­ch thÆ°Æ¡ng máº¡i Ä‘Ã¡ng ká»ƒ.

CÃ¡c ná»— lá»±c nÃ©n bá»™ nhá»› Ä‘á»‡m KV hiá»‡n cÃ³ cÃ³ thá»ƒ Ä‘Æ°á»£c phÃ¢n loáº¡i thÃ´ thÃ nh hai loáº¡i, cá»¥ thá»ƒ lÃ  lÆ°á»£ng tá»­ hÃ³a vÃ  thÆ°a thá»›t. CÃ¡c phÆ°Æ¡ng phÃ¡p lÆ°á»£ng tá»­ hÃ³a [11,12] Ä‘á» xuáº¥t lÆ°u trá»¯ cÃ¡c tráº¡ng thÃ¡i KV trong cÃ¡c giÃ¡ trá»‹ sá»‘ bit tháº¥p. ThÃ´ng thÆ°á»ng, FlexGen [13] chá»©ng minh ráº±ng lÆ°á»£ng tá»­ hÃ³a bá»™ nhá»› Ä‘á»‡m KV 4-bit cÃ³ thá»ƒ Ä‘áº¡t Ä‘Æ°á»£c hiá»‡u nÄƒng khÃ´ng máº¥t mÃ¡t. NgÆ°á»£c láº¡i, cÃ¡c phÆ°Æ¡ng phÃ¡p hÆ°á»›ng thÆ°a thá»›t nháº±m chá»‰ giá»¯ láº¡i cÃ¡c token ná»•i báº­t trong khi loáº¡i bá» pháº§n cÃ²n láº¡i, cÃ³ thá»ƒ heuristic [14,15] hoáº·c adaptive [16]. Má»™t sá»‘ phÆ°Æ¡ng phÃ¡p [11] khÃ¡m phÃ¡ giao Ä‘iá»ƒm cá»§a hai loáº¡i nÃ y, báº±ng cÃ¡ch gÃ¡n bit cao cho cÃ¡c token ná»•i báº­t vÃ  bit cá»±c tháº¥p cho pháº§n cÃ²n láº¡i cá»§a cÃ¡c token, Ä‘áº¡t Ä‘Æ°á»£c má»©c tÄƒng bá»™ nhá»› tÃ­ch cá»±c hÆ¡n. Máº·c dÃ¹ cÃ³ nhá»¯ng Ä‘á»•i má»›i nÃ y, tÃ i liá»‡u hiá»‡n cÃ³ chá»‰ xem xÃ©t sá»± dÆ° thá»«a intra-layer, trong khi bá» qua má»™t hÆ°á»›ng bá»• sung quan trá»ng khÃ¡c â€“ sá»± dÆ° thá»«a inter-layer, nhÆ° Ä‘Æ°á»£c minh há»a trong HÃ¬nh 1(c).

PhÃ¢n tÃ­ch cá»§a chÃºng tÃ´i báº¯t Ä‘áº§u báº±ng viá»‡c khÃ¡m phÃ¡ sá»± dÆ° thá»«a cá»§a bá»™ nhá»› Ä‘á»‡m KV dá»c theo chiá»u sÃ¢u, nhÆ° Ä‘Æ°á»£c hiá»ƒn thá»‹ trong HÃ¬nh 1(a). ChÃºng tÃ´i quan sÃ¡t tháº¥y ráº±ng cÃ¡c tráº¡ng thÃ¡i bá»™ nhá»› Ä‘á»‡m KV thá»ƒ hiá»‡n Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng cao giá»¯a cÃ¡c lá»›p lÃ¡ng giá»ng trong

---

cÃ¡c pháº§n giá»¯a Ä‘áº¿n sÃ¢u cá»§a LLM. TÃ­nh cháº¥t thÃº vá»‹ nÃ y gá»£i Ã½ ráº±ng cÃ¡c tráº¡ng thÃ¡i Ä‘Æ°á»£c ghÃ©p ná»‘i theo vá»‹ trÃ­ giá»¯a cÃ¡c lá»›p liá»n ká» cÃ³ thá»ƒ Ä‘Æ°á»£c há»£p nháº¥t chÃ­nh xÃ¡c thÃ nh má»™t khÃ´ng gian tráº¡ng thÃ¡i duy nháº¥t vá»›i Ä‘áº£m báº£o hiá»‡u nÄƒng máº¡nh máº½, nhÆ° Ä‘Æ°á»£c minh há»a trong HÃ¬nh 1(b). PhÆ°Æ¡ng phÃ¡p nÃ y giáº£m Ä‘Ã¡ng ká»ƒ dung lÆ°á»£ng bá»™ nhá»› mÃ  khÃ´ng cáº§n giá»¯ láº¡i cÃ¡c tráº¡ng thÃ¡i riÃªng láº» cho tá»«ng lá»›p attention. LÆ°u Ã½ ráº±ng nhá»¯ng quan sÃ¡t nÃ y liÃªn quan Ä‘áº¿n cÃ¡c chiáº¿n lÆ°á»£c suy luáº­n Ä‘á»™ng nhÆ° mixture-of-depths [17] vÃ  layer-wise early exiting [18,19], tá»‘i Æ°u hÃ³a cÃ¡c Ä‘Æ°á»ng dáº«n tÃ­nh toÃ¡n báº±ng cÃ¡ch bá» qua cÃ¡c lá»›p khÃ´ng quan trá»ng Ä‘á»ƒ nÃ¢ng cao hiá»‡u quáº£ huáº¥n luyá»‡n vÃ  suy luáº­n. HÆ¡n ná»¯a, cÃ¡c phÆ°Æ¡ng phÃ¡p pruning lá»›p [20] nÃªu báº­t sá»± dÆ° thá»«a Ä‘Ã¡ng ká»ƒ trong cÃ¡c lá»›p sÃ¢u hÆ¡n. Tuy nhiÃªn, báº¥t cháº¥p nhá»¯ng tiáº¿n bá»™ nÃ y, sá»± dÆ° thá»«a cá»§a bá»™ nhá»› Ä‘á»‡m KV dá»c theo chiá»u sÃ¢u Ä‘Ã£ pháº§n lá»›n bá»‹ bá» qua.

Trong bÃ i bÃ¡o nÃ y, chÃºng tÃ´i Ä‘á» xuáº¥t MiniCache, má»™t phÆ°Æ¡ng phÃ¡p nÃ©n bá»™ nhá»› Ä‘á»‡m KV qua lá»›p Ä‘Æ¡n giáº£n nhÆ°ng hiá»‡u quáº£ nháº±m thÃºc Ä‘áº©y hiá»‡u quáº£ suy luáº­n cá»§a LLM. MiniCache bao gá»“m hai thÃ nh pháº§n thiáº¿t yáº¿u. Äáº§u tiÃªn, chÃºng tÃ´i giá»›i thiá»‡u má»™t chiáº¿n lÆ°á»£c há»£p nháº¥t cache chÃ­nh xÃ¡c, sá»­ dá»¥ng tÃ¡i tham sá»‘ hÃ³a cá»§a cÃ¡c vector tráº¡ng thÃ¡i phÃ¢n tÃ¡ch chÃºng thÃ nh cÃ¡c thÃ nh pháº§n Ä‘á»™ lá»›n vÃ  hÆ°á»›ng, tÆ°Æ¡ng tá»± nhÆ° weight normalization [21]. PhÆ°Æ¡ng phÃ¡p nÃ y cho phÃ©p ná»™i suy hiá»‡u quáº£ cá»§a thÃ nh pháº§n hÆ°á»›ng trong tá»a Ä‘á»™ cá»±c trong khi báº£o tá»“n norm tráº¡ng thÃ¡i gá»‘c Ä‘á»ƒ giá»¯ láº¡i cÃ ng nhiá»u thÃ´ng tin cÃ ng tá»‘t. Ná»™i suy nÃ y Ä‘á» cáº­p Ä‘áº¿n há»£p nháº¥t qua lá»›p nhÆ° Ä‘Æ°á»£c hiá»ƒn thá»‹ trong HÃ¬nh 1(c). Thá»© hai, chÃºng tÃ´i nháº­n ra ráº±ng má»™t táº­p con nhá» cÃ¡c cáº·p tráº¡ng thÃ¡i, Ä‘Æ°á»£c Ä‘áº·c trÆ°ng bá»Ÿi Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng tháº¥p nhÆ°ng mang Ã½ nghÄ©a ngá»¯ nghÄ©a khÃ¡c biá»‡t lá»›n, khÃ´ng phÃ¹ há»£p cho viá»‡c há»£p nháº¥t inter-layer. Äá»ƒ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y, chÃºng tÃ´i Ä‘á» xuáº¥t má»™t chiáº¿n lÆ°á»£c giá»¯ láº¡i token Ä‘á»ƒ giáº£m thiá»ƒu suy giáº£m hiá»‡u nÄƒng, bao gá»“m viá»‡c giá»¯ láº¡i riÃªng biá»‡t nhá»¯ng cáº·p ngoáº¡i lá»‡ nÃ y. Khung cá»§a chÃºng tÃ´i Ä‘áº·c biá»‡t hiá»‡u quáº£ vá» bá»™ nhá»›, yÃªu cáº§u lÆ°u trá»¯ chá»‰ má»™t thÃ nh pháº§n hÆ°á»›ng chiá»u cao duy nháº¥t, cÃ¹ng vá»›i chi phÃ­ bá»™ nhá»› bá»• sung tá»‘i thiá»ƒu. Chi phÃ­ nÃ y bao gá»“m má»™t sá»‘ token khÃ´ng thá»ƒ há»£p nháº¥t vÃ  cÃ¡c chá»‰ sá»‘ tÆ°Æ¡ng á»©ng cá»§a chÃºng, cÅ©ng nhÆ° Ä‘á»™ lá»›n theo token Ä‘á»ƒ khÃ´i phá»¥c chÃ­nh xÃ¡c cÃ¡c tráº¡ng thÃ¡i gá»‘c.

ChÃºng tÃ´i tiáº¿n hÃ nh cÃ¡c thÃ­ nghiá»‡m má»Ÿ rá»™ng vá»›i cÃ¡c LLM Ä‘áº¡i diá»‡n, bao gá»“m Mixtral-8x7B [22], Phi-3-Mini [23], vÃ  LLaMA-3 [6] 8B vÃ  70B, tÆ°Æ¡ng á»©ng. PhÆ°Æ¡ng phÃ¡p cá»§a chÃºng tÃ´i Ä‘Æ°á»£c benchmark trÃªn má»™t loáº¡t cÃ¡c bá»™ dá»¯ liá»‡u tráº£ lá»i cÃ¢u há»i vÃ  táº¡o Ä‘a dáº¡ng [24,25,26,27,28,29,30,31] sá»­ dá»¥ng lm-eval-harness [32]. NgoÃ i ra, chÃºng tÃ´i Ä‘Ã¡nh giÃ¡ káº¿t quáº£ cá»§a mÃ¬nh trÃªn LongBench [33] cho viá»‡c táº¡o chuá»—i dÃ i. Káº¿t quáº£ chá»©ng minh ráº±ng MiniCache cÃ³ thá»ƒ giáº£m dung lÆ°á»£ng bá»™ nhá»› cáº§n thiáº¿t cho suy luáº­n LLM lÃªn Ä‘áº¿n 41%, Ä‘á»“ng thá»i nÃ¢ng cao thÃ´ng lÆ°á»£ng khoáº£ng 5Ã— so vá»›i baseline cache Ä‘áº§y Ä‘á»§, vÆ°á»£t trá»™i rÃµ rÃ ng so vá»›i cÃ¡c phÆ°Æ¡ng phÃ¡p hiá»‡n cÃ³ [11, 12, 14, 15].

ÄÃ³ng gÃ³p cá»§a chÃºng tÃ´i Ä‘Æ°á»£c tÃ³m táº¯t nhÆ° sau:

â€¢ ChÃºng tÃ´i giá»›i thiá»‡u MiniCache, má»™t khung Ä‘Æ¡n giáº£n nhÆ°ng hiá»‡u quáº£ cao cho nÃ©n bá»™ nhá»› Ä‘á»‡m KV. MiniCache tiÃªn phong trong viá»‡c khÃ¡m phÃ¡ nÃ©n bá»™ nhá»› Ä‘á»‡m KV dá»c theo chiá»u sÃ¢u, tá»« Ä‘Ã³ má»Ÿ rá»™ng Ä‘Ã¡ng ká»ƒ kháº£ nÄƒng cá»§a nÃ³.

â€¢ ChÃºng tÃ´i quan sÃ¡t má»™t Ä‘áº·c Ä‘iá»ƒm thÃº vá»‹ cá»§a cÃ¡c tráº¡ng thÃ¡i bá»™ nhá»› Ä‘á»‡m KV qua lá»›p: Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng cao giá»¯a cÃ¡c lá»›p liá»n ká» trong cÃ¡c giai Ä‘oáº¡n giá»¯a Ä‘áº¿n sau cá»§a LLM. NgoÃ i ra, chÃºng tÃ´i phÃ¡t hiá»‡n ráº±ng khÃ´ng pháº£i táº¥t cáº£ cÃ¡c cáº·p tráº¡ng thÃ¡i Ä‘á»u phÃ¹ há»£p Ä‘á»ƒ há»£p nháº¥t.

â€¢ ChÃºng tÃ´i Ä‘á» xuáº¥t má»™t phÆ°Æ¡ng phÃ¡p chÃ­nh xÃ¡c vÃ  hiá»‡u quáº£ bá»™ nhá»› cho viá»‡c há»£p nháº¥t cache qua lá»›p, bao gá»“m má»™t chiáº¿n lÆ°á»£c tÃ¡i tham sá»‘ hÃ³a vÃ  má»™t cÆ¡ cháº¿ giá»¯ láº¡i token. PhÆ°Æ¡ng phÃ¡p cá»§a chÃºng tÃ´i bá»• sung cho cÃ¡c phÆ°Æ¡ng phÃ¡p nÃ©n bá»™ nhá»› Ä‘á»‡m KV hiá»‡n cÃ³, nÃ¢ng cao hÆ¡n ná»¯a hiá»‡u quáº£ phá»¥c vá»¥ LLM.

â€¢ MiniCache cá»§a chÃºng tÃ´i hoáº¡t Ä‘á»™ng tá»‘t so vá»›i cÃ¡c phÆ°Æ¡ng phÃ¡p tiÃªn tiáº¿n. Äáº·c biá»‡t, MiniCache 4-bit cá»§a chÃºng tÃ´i Ä‘áº¡t Ä‘Æ°á»£c tá»· lá»‡ nÃ©n máº¡nh lÃªn Ä‘áº¿n 5.02Ã—, thÃ´ng lÆ°á»£ng suy luáº­n cao hÆ¡n 5Ã— vÃ  giáº£m bá»™ nhá»› 41% so vá»›i baseline cache Ä‘áº§y Ä‘á»§ FP16 vá»›i hiá»‡u nÄƒng gáº§n nhÆ° khÃ´ng máº¥t mÃ¡t.

## 2 CÃ´ng trÃ¬nh liÃªn quan

**Suy luáº­n hiá»‡u quáº£ cho LLM.** CÃ¡c MÃ´ hÃ¬nh NgÃ´n ngá»¯ Lá»›n (LLM) bá»‹ háº¡n cháº¿ bá»Ÿi cÃ¡c yÃªu cáº§u tÃ­nh toÃ¡n vÃ  bá»™ nhá»› Ä‘Ã¡ng ká»ƒ trong quÃ¡ trÃ¬nh suy luáº­n, Ä‘áº·c biá»‡t trong cÃ¡c mÃ´i trÆ°á»ng háº¡n cháº¿ tÃ i nguyÃªn. Äá»ƒ giáº£m thiá»ƒu nhá»¯ng thÃ¡ch thá»©c nÃ y, nhiá»u ká»¹ thuáº­t suy luáº­n hiá»‡u quáº£ Ä‘Ã£ Ä‘Æ°á»£c phÃ¡t triá»ƒn. VÃ­ dá»¥, cÃ¡c phÆ°Æ¡ng phÃ¡p suy luáº­n Ä‘á»™ng [18,34,35,36], Ä‘Æ°á»£c Ä‘áº¡i diá»‡n bá»Ÿi mixture-of-experts (MoE) [37,38,39,40,41], chá»n lá»c thÃ­ch á»©ng cÃ¡c cáº¥u trÃºc con cá»¥ thá»ƒ cá»§a mÃ´ hÃ¬nh trong quÃ¡ trÃ¬nh suy luáº­n dá»±a trÃªn dá»¯ liá»‡u Ä‘áº§u vÃ o, cáº£i thiá»‡n Ä‘Ã¡ng ká»ƒ hiá»‡u quáº£ suy luáº­n trong khi giá»¯ kháº£ nÄƒng mÃ´ hÃ¬nh. CÃ¡c ká»¹ thuáº­t nhÆ° Multi-Query Attention [42,43], Kernel-driven attentions [44,45,46,47], vÃ  low-rank attentions [41,48,49,50] xáº¥p xá»‰ chá»©c nÄƒng cá»§a cÃ¡c cÆ¡ cháº¿ attention truyá»n thá»‘ng nhÆ°ng vá»›i cÃ¡c triá»ƒn khai hiá»‡u quáº£ hÆ¡n. CÃ¡c chiáº¿n lÆ°á»£c lÆ°á»£ng tá»­ hÃ³a [51,52,53,54]

---

bao gá»“m viá»‡c chuyá»ƒn Ä‘á»•i trá»ng sá»‘ vÃ  activation cá»§a mÃ´ hÃ¬nh sang Ä‘á»‹nh dáº¡ng bit-width tháº¥p, tá»« Ä‘Ã³ giáº£m dung lÆ°á»£ng bá»™ nhá»› vÃ  cÆ°á»ng Ä‘á»™ tÃ­nh toÃ¡n. CÃ¡c phÆ°Æ¡ng phÃ¡p sparsification [14,15,55,56] loáº¡i bá» cÃ¡c yáº¿u tá»‘ khÃ´ng cáº§n thiáº¿t trong cáº£ trá»ng sá»‘ mÃ´ hÃ¬nh vÃ  biá»ƒu diá»…n token, nÃ¢ng cao hÆ¡n ná»¯a hiá»‡u quáº£.

Má»™t sá»‘ cÃ´ng trÃ¬nh liÃªn quan cháº·t cháº½, nhÆ° MoD [17] vÃ  LayerSkips [19], xem xÃ©t báº£n cháº¥t suy luáº­n Ä‘á»™ng Ä‘á»ƒ bá» qua cÃ¡c lá»›p khÃ´ng quan trá»ng theo Ä‘áº§u vÃ o. Tuy nhiÃªn, nhá»¯ng phÆ°Æ¡ng phÃ¡p nÃ y yÃªu cáº§u má»™t quÃ¡ trÃ¬nh fine-tuning bá»• sung hoáº·c cÃ¡c giai Ä‘oáº¡n pre-training Ä‘Æ°á»£c thiáº¿t káº¿ cáº©n tháº­n, Ä‘iá»u nÃ y lÃ m giáº£m tÃ­nh thÃ­ch á»©ng cá»§a nhá»¯ng phÆ°Æ¡ng phÃ¡p nÃ y. MiniCache dá»±a vÃ o cÃ¡c quan sÃ¡t tÆ°Æ¡ng Ä‘á»“ng inter-layer Ä‘á»ƒ thá»±c hiá»‡n há»£p nháº¥t qua lá»›p, giáº£m Ä‘Ã¡ng ká»ƒ nhu cáº§u bá»™ nhá»›.

**Há»£p nháº¥t mÃ´ hÃ¬nh.** NÃ©n há»£p nháº¥t bao gá»“m viá»‡c tá»•ng há»£p cÃ¡c tham sá»‘ vÃ  activation cá»§a mÃ´ hÃ¬nh á»Ÿ cÃ¡c má»©c Ä‘á»™ chi tiáº¿t khÃ¡c nhau. QuÃ¡ trÃ¬nh nÃ y nÃ¢ng cao hiá»‡u quáº£ suy luáº­n trong cÃ¡c mÃ´ hÃ¬nh lá»›n vÃ  táº¡o Ä‘iá»u kiá»‡n cho sá»± dÆ° thá»«a khá»•ng lá»“ [57]. Linear Mode Connectivity (LMC) [58] cho phÃ©p fine-tuning cÃ¡c mÃ´ hÃ¬nh tá»« má»™t cÆ¡ sá»Ÿ pre-trained Ä‘Æ°á»£c chia sáº». ThÃ´ng thÆ°á»ng, trung bÃ¬nh trá»ng sá»‘ [59] Ä‘Æ°á»£c sá»­ dá»¥ng nhÆ° má»™t ká»¹ thuáº­t hiá»‡u quáº£ Ä‘á»ƒ thá»±c hiá»‡n nÃ©n há»£p nháº¥t. ÄÃ¡ng chÃº Ã½, Model Soup [60] sá»­ dá»¥ng trung bÃ¬nh tuyáº¿n tÃ­nh trong bá»‘i cáº£nh nÃ y. CÃ¡c phÆ°Æ¡ng phÃ¡p tiÃªn tiáº¿n nhÆ° TIES Merging [61], Model Breadcrumbs [62], vÃ  DARE [63] nÃ¢ng cao hÆ¡n ná»¯a quÃ¡ trÃ¬nh nÃ y báº±ng cÃ¡ch sparsifying vÃ  káº¿t há»£p cÃ¡c tham sá»‘ mÃ´ hÃ¬nh, cho phÃ©p há»£p nháº¥t cÃ¡c mÃ´ hÃ¬nh mÃ  khÃ´ng hy sinh kháº£ nÄƒng hiá»‡u nÄƒng. NgoÃ i ra, Spherical Linear intERPolation (SLERP) [64] má»Ÿ rá»™ng ra ngoÃ i viá»‡c trung bÃ¬nh trá»ng sá»‘ Ä‘Æ¡n giáº£n báº±ng cÃ¡ch ná»™i suy giá»¯a cÃ¡c tham sá»‘ mÃ´ hÃ¬nh. Ma tráº­n thÃ´ng tin Fisher [65] vÃ  cÃ¡c phÆ°Æ¡ng phÃ¡p dá»±a trÃªn RegMean [66] tá»‘i Æ°u hÃ³a hÆ¡n ná»¯a cÃ¡c há»£p nháº¥t Ä‘á»ƒ táº¡o ra trá»ng sá»‘ lÃ½ tÆ°á»Ÿng, giáº£m thiá»ƒu khoáº£ng cÃ¡ch â„“2 Ä‘áº¿n Ä‘áº§u ra generation trong khi báº£o tá»“n tÃ­nh riÃªng tÆ° cá»§a dá»¯ liá»‡u huáº¥n luyá»‡n. Tuy nhiÃªn, háº§u háº¿t cÃ¡c cÃ´ng trÃ¬nh hiá»‡n cÃ³ táº­p trung vÃ o viá»‡c há»£p nháº¥t cÃ¡c tham sá»‘ mÃ´ hÃ¬nh, vá»›i khÃ¡i niá»‡m kháº£ nÄƒng há»£p nháº¥t theo chiá»u sÃ¢u khÃ´ng Ä‘Æ°á»£c khÃ¡m phÃ¡ ká»¹ lÆ°á»¡ng trong nghiÃªn cá»©u trÆ°á»›c Ä‘Ã³. MiniCache táº­p trung vÃ o viá»‡c há»£p nháº¥t token bá»™ nhá»› Ä‘á»‡m KV trong chiá»u sÃ¢u cá»§a LLM.

## 3 Äá»™ng lá»±c

DÆ°á»›i Ä‘Ã¢y, chÃºng tÃ´i trÃ¬nh bÃ y cÃ¡c quan sÃ¡t má»›i cá»§a mÃ¬nh trong má»™t gÃ³c nhÃ¬n qua lá»›p má»›i.

---

**HÃ¬nh 2:** Tá»•ng quan vá» cÃ¡c khÃ¡m phÃ¡ vÃ  quan sÃ¡t cá»§a chÃºng tÃ´i: (a) hiá»ƒn thá»‹ baseline máº¡nh báº±ng cÃ¡ch thá»±c hiá»‡n há»£p nháº¥t trung bÃ¬nh trÃªn bá»™ nhá»› Ä‘á»‡m KV. (b) hiá»ƒn thá»‹ Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng theo cáº·p cá»§a cÃ¡c tráº¡ng thÃ¡i cache giá»¯a cÃ¡c lá»›p liá»n ká». (c) so sÃ¡nh MiniCache, trung bÃ¬nh Ä‘Æ¡n giáº£n, vÃ  baseline cache Ä‘áº§y Ä‘á»§ trÃªn nÄƒm bá»™ dá»¯ liá»‡u khÃ¡c nhau.

### 3.1 Sá»± dÆ° thá»«a qua lá»›p trong KV Cache

CÃ¡c nghiÃªn cá»©u trÆ°á»›c Ä‘Ã£ tiáº¿t lá»™ tÃ­nh khÃ´ng hiá»‡u quáº£ cá»§a cÃ¡c lá»›p giá»¯a Ä‘áº¿n sÃ¢u trong LLM [20]. Do Ä‘Ã³, early exiting theo lá»›p trong trÆ°á»ng há»£p nÃ y cÃ³ thá»ƒ trÃ¡nh hiá»‡u quáº£ tÃ­nh toÃ¡n dÆ° thá»«a vá»›i áº£nh hÆ°á»Ÿng nhá» Ä‘áº¿n hiá»‡u nÄƒng LLM [19,67]. ÄÆ°á»£c truyá»n cáº£m há»©ng tá»« Ä‘iá»u nÃ y, chÃºng tÃ´i khÃ¡m phÃ¡ viá»‡c há»£p nháº¥t bá»™ nhá»› Ä‘á»‡m KV theo lá»›p trong LLM, báº¯t Ä‘áº§u vá»›i má»™t baseline Ä‘Æ¡n giáº£n báº±ng cÃ¡ch trung bÃ¬nh toÃ n bá»™ token qua cÃ¡c lá»›p liá»n ká». ChÃºng tÃ´i cung cáº¥p cÃ¡c quan sÃ¡t chÃ­nh nhÆ° sau.

**Quan sÃ¡t 1: KV cache chia sáº» Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng cao giá»¯a cÃ¡c lá»›p liá»n ká».** Dá»±a trÃªn LLaMA-3-70B [6], chÃºng tÃ´i tiáº¿n hÃ nh suy luáº­n zero-shot trÃªn cÃ¡c táº­p validation cá»§a ba benchmark Ä‘Æ°á»£c cÃ´ng nháº­n rá»™ng rÃ£i: COQA [68], GSM8K [10] vÃ  TruthfulQA [69]. NÃ³i chung, chÃºng tÃ´i tháº¥y ráº±ng KV cache trong cÃ¡c lá»›p nÃ´ng thá»ƒ hiá»‡n Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng tháº¥p, trong khi nhá»¯ng lá»›p trong cÃ¡c lá»›p giá»¯a Ä‘áº¿n sÃ¢u ráº¥t tÆ°Æ¡ng Ä‘á»“ng vá»›i nhau dá»±a trÃªn khoáº£ng cÃ¡ch gÃ³c, nhÆ° Ä‘Æ°á»£c hiá»ƒn thá»‹ trong HÃ¬nh 1(b). Tiáº¿p theo, chÃºng tÃ´i há»£p nháº¥t bá»™ nhá»› Ä‘á»‡m KV qua

---

cÃ¡c lá»›p liá»n ká» báº±ng cÃ¡ch tiáº¿n hÃ nh suy luáº­n five-shot vá»›i LLaMA-2-7B, LLaMA-2-13B [5], LLaMA-3-8B [6], vÃ  Mixtral-8x7B [22] trÃªn GSM8K [10]. Cá»¥ thá»ƒ, báº¯t Ä‘áº§u tá»« lá»›p giá»¯a cá»§a má»—i mÃ´ hÃ¬nh, chÃºng tÃ´i há»£p nháº¥t bá»™ nhá»› Ä‘á»‡m KV trong hai lá»›p liá»n ká». NhÆ° Ä‘Æ°á»£c hiá»ƒn thá»‹ trong HÃ¬nh 2(a), chÃºng tÃ´i quan sÃ¡t hiá»‡u nÄƒng thuáº­n lá»£i cho cÃ¡c LLM khÃ¡c nhau, Ä‘iá»u nÃ y tiáº¿t lá»™ tiá»m nÄƒng lá»›n Ä‘á»ƒ cáº£i thiá»‡n hiá»‡u quáº£ báº±ng cÃ¡ch chia sáº» bá»™ nhá»› Ä‘á»‡m KV qua cÃ¡c lá»›p liá»n ká» trong quÃ¡ trÃ¬nh decoding LLM.

**Quan sÃ¡t 2: KhÃ´ng pháº£i táº¥t cáº£ token Ä‘á»u quan trá»ng nhÆ° nhau Ä‘á»ƒ há»£p nháº¥t, má»™t sá»‘ cáº·p khÃ¡c biá»‡t yÃªu cáº§u giá»¯ láº¡i.** CÃ¡c cÃ´ng trÃ¬nh gáº§n Ä‘Ã¢y [15,16] trong nÃ©n bá»™ nhá»› Ä‘á»‡m KV Ä‘Ã£ phÃ¡t hiá»‡n ráº±ng giá»¯ má»™t sá»‘ token ná»•i báº­t táº¡i má»—i lá»›p, Ä‘Ã³ng gÃ³p pháº§n lá»›n Ä‘iá»ƒm attention, cÃ³ thá»ƒ Ä‘á»§ Ä‘á»ƒ duy trÃ¬ hiá»‡u nÄƒng LLM. Trong trÆ°á»ng há»£p cá»§a chÃºng tÃ´i, chÃºng tÃ´i suy Ä‘oÃ¡n ráº±ng má»™t sá»‘ cáº·p token trong cÃ¡c lá»›p liá»n ká» cÅ©ng thá»ƒ hiá»‡n hÃ nh vi ngoáº¡i lá»‡, cho tháº¥y sá»± khÃ¡c biá»‡t ngá»¯ nghÄ©a máº¡nh khiáº¿n chÃºng khÃ´ng phÃ¹ há»£p Ä‘á»ƒ há»£p nháº¥t. Dá»±a trÃªn COQA [68] vÃ  LLaMA-2-7B [5], chÃºng tÃ´i Ä‘iá»u tra Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng á»Ÿ cáº¥p Ä‘á»™ cáº·p token. NhÆ° Ä‘Æ°á»£c hiá»ƒn thá»‹ trong HÃ¬nh 2(b), chÃºng tÃ´i tháº¥y má»™t pháº§n Ä‘Ã¡ng ká»ƒ cÃ¡c cáº·p token chia sáº» Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng cao qua cÃ¡c lá»›p liá»n ká». Tuy nhiÃªn, chÃºng tÃ´i quan sÃ¡t má»™t sá»‘ cáº·p ngoáº¡i lá»‡, nhÆ° chá»‰ sá»‘ 0 vÃ  15, vá»›i margin khÃ¡c biá»‡t lá»›n. ChÃºng tÃ´i coi nhá»¯ng token nÃ y khÃ´ng thá»ƒ há»£p nháº¥t do sá»± khÃ¡c biá»‡t Ä‘Ã¡ng ká»ƒ cá»§a chÃºng. ChÃºng tÃ´i cÅ©ng cho tháº¥y ráº±ng viá»‡c há»£p nháº¥t nhá»¯ng token khÃ¡c biá»‡t nÃ y dáº«n Ä‘áº¿n suy giáº£m hiá»‡u nÄƒng, tÆ°Æ¡ng á»©ng vá»›i Î³ = 0 row trong Báº£ng 2. Do Ä‘Ã³, trong khi há»£p nháº¥t qua lá»›p lÃ  má»™t chiáº¿n lÆ°á»£c Ä‘áº§y há»©a háº¹n Ä‘á»ƒ giáº£m gÃ¡nh náº·ng bá»™ nhá»›, nÃ³ pháº£i Ä‘Æ°á»£c triá»ƒn khai vá»›i sá»± xem xÃ©t cáº©n tháº­n vá» Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng cáº¥p token Ä‘á»ƒ Ä‘áº£m báº£o hiá»‡u nÄƒng tá»‘i Æ°u, nhÆ° Ä‘Æ°á»£c hiá»ƒn thá»‹ trong HÃ¬nh 2(c).

## 4 PhÆ°Æ¡ng phÃ¡p

Trong pháº§n nÃ y, chÃºng tÃ´i giá»›i thiá»‡u MiniCache cá»§a chÃºng tÃ´i, má»™t phÆ°Æ¡ng phÃ¡p Ä‘Æ¡n giáº£n nhÆ°ng hiá»‡u quáº£ nháº±m cáº¯t giáº£m sá»± dÆ° thá»«a bá»™ nhá»› Ä‘á»‡m KV trong chiá»u sÃ¢u. Khung nÃ y khai thÃ¡c Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng cao cá»§a cÃ¡c tráº¡ng thÃ¡i bá»™ nhá»› Ä‘á»‡m KV giá»¯a cÃ¡c lá»›p liá»n ká» vÃ  bao gá»“m hai thÃ nh pháº§n chÃ­nh: má»™t chiáº¿n lÆ°á»£c há»£p nháº¥t dá»±a trÃªn tÃ¡i tham sá»‘ hÃ³a vÃ  má»™t cÆ¡ cháº¿ giá»¯ láº¡i token. Chiáº¿n lÆ°á»£c há»£p nháº¥t nÃ©n cÃ¡c tráº¡ng thÃ¡i bá»™ nhá»› Ä‘á»‡m KV trong cÃ¡c lá»›p liá»n ká» Ä‘á»ƒ tá»•ng há»£p chÃºng thÃ nh má»™t khÃ´ng gian bá»™ nhá»› chia sáº» duy nháº¥t, báº¯t Ä‘áº§u tá»« giá»¯a mÃ´ hÃ¬nh. CÆ¡ cháº¿ giá»¯ láº¡i token giáº£m thiá»ƒu thÃ´ng tin bá»‹ máº¥t báº±ng cÃ¡ch giá»¯ láº¡i cÃ¡c cáº·p tráº¡ng thÃ¡i khÃ¡c biá»‡t cao vá»›i chi phÃ­ bá»™ nhá»› bá»• sung tá»‘i thiá»ƒu. Vá»›i cache Ä‘Ã£ há»£p nháº¥t, token giá»¯ láº¡i, vÃ  Ä‘á»™ lá»›n, chÃºng tÃ´i cÃ³ thá»ƒ khÃ´i phá»¥c chÃ­nh xÃ¡c cÃ¡c tráº¡ng thÃ¡i cache gá»‘c Ä‘á»ƒ decoding token.

### 4.1 NÃ©n qua lá»›p

PhÆ°Æ¡ng phÃ¡p cá»§a chÃºng tÃ´i báº¯t Ä‘áº§u vá»›i viá»‡c xÃ¡c Ä‘á»‹nh lá»›p báº¯t Ä‘áº§u tá»‘i Æ°u S. CÃ¡c quan sÃ¡t trong Pháº§n 3.1 chá»‰ ra ráº±ng bá»™ nhá»› Ä‘á»‡m KV tá»« cÃ¡c lá»›p giá»¯a Ä‘áº¿n sÃ¢u liÃªn tá»¥c thá»ƒ hiá»‡n cÃ¡c máº«u Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng cao qua cÃ¡c lá»›p liá»n ká». Do Ä‘Ã³, chÃºng tÃ´i chá»n lá»›p báº¯t Ä‘áº§u tá»« giá»¯a LLM, cá»¥ thá»ƒ S = L/2. Tá»« lá»›p nÃ y trá»Ÿ Ä‘i, cÃ¡c cáº·p KV Ä‘Æ°á»£c giáº£ Ä‘á»‹nh lÃ  Ä‘á»§ tÆ°Æ¡ng Ä‘á»“ng qua cÃ¡c lá»›p liá»n ká» Ä‘á»ƒ Ä‘áº£m báº£o viá»‡c há»£p nháº¥t cá»§a chÃºng. Trung tÃ¢m cá»§a phÆ°Æ¡ng phÃ¡p nÃ y lÃ  má»™t hÃ m há»£p nháº¥t, F, Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ tÃ­ch há»£p cÃ¡c bá»™ nhá»› Ä‘á»‡m KV cá»§a cÃ¡c lá»›p liÃªn tiáº¿p thÃ nh má»™t cache thá»‘ng nháº¥t duy nháº¥t. ChÃºng tÃ´i Ä‘á»‹nh nghÄ©a x lÃ  tráº¡ng thÃ¡i cache vector hÃ³a cá»§a má»™t token duy nháº¥t, trong Ä‘Ã³ chá»‰ sá»‘ trÃªn chá»‰ ra chá»‰ sá»‘ lá»›p vÃ  cÃ¡c chá»‰ sá»‘ dÆ°á»›i k vÃ  v biá»ƒu thá»‹ cÃ¡c key vÃ  value, tÆ°Æ¡ng á»©ng. Cá»¥ thá»ƒ, cho má»™t cáº·p key/value token táº¡i cÃ¹ng má»™t vá»‹ trÃ­ trong cÃ¡c lá»›p l vÃ  lâˆ’1, cache Ä‘Ã£ há»£p nháº¥t Ä‘Æ°á»£c tÃ­nh nhÆ°

c^{l,lâˆ’1}_k = F(x^l_k, x^{lâˆ’1}_k),
c^{l,lâˆ’1}_v = F(x^l_v, x^{lâˆ’1}_v). (1)

QuÃ¡ trÃ¬nh há»£p nháº¥t nÃ y hiá»‡u quáº£ loáº¡i bá» nhu cáº§u lÆ°u trá»¯ vÃ  xá»­ lÃ½ cÃ¡c key vÃ  value tá»‘n nhiá»u bá»™ nhá»› gá»‘c trong má»—i lá»›p má»™t cÃ¡ch Ä‘á»™c láº­p. Thay vÃ o Ä‘Ã³, nÃ³ xáº¥p xá»‰ má»™t cache chia sáº» qua cÃ¡c lá»›p liá»n ká».

### 4.2 Há»£p nháº¥t vÃ  khÃ´i phá»¥c KV Cache

**Há»£p nháº¥t cache dá»±a trÃªn tÃ¡i tham sá»‘ hÃ³a.** Äá»ƒ thá»±c hiá»‡n há»£p nháº¥t theo cáº·p, má»™t giáº£i phÃ¡p lÃ  trá»±c tiáº¿p trung bÃ¬nh má»™t cáº·p token KV, tÆ°Æ¡ng tá»± nhÆ° há»£p nháº¥t mÃ´ hÃ¬nh [60,61]. Tuy nhiÃªn, chÃºng tÃ´i quan sÃ¡t ráº±ng viá»‡c trung bÃ¬nh trá»±c tiáº¿p cÃ³ thá»ƒ gÃ¢y ra máº¥t thÃ´ng tin Ä‘Ã¡ng ká»ƒ. ChÃºng tÃ´i suy Ä‘oÃ¡n ráº±ng khoáº£ng cÃ¡ch giá»¯a cÃ¡c activation cÃ³ thá»ƒ lá»›n hÆ¡n so vá»›i cÃ¡c trá»ng sá»‘ do sá»± hiá»‡n diá»‡n cá»§a cÃ¡c kÃªnh activation ngoáº¡i lá»‡ vá»›i Ä‘á»™ lá»›n cá»±c lá»›n trong LLM [70,71], trong khi trá»ng sá»‘ thÆ°á»ng cÃ³ Ä‘á»™ lá»›n tÆ°Æ¡ng Ä‘á»‘i khÃ¡ nhá». Má»™t phÆ°Æ¡ng phÃ¡p tiá»m nÄƒng Ä‘á»ƒ bÃ¹ Ä‘áº¯p cho máº¥t thÃ´ng tin nÃ y lÃ  chiáº¿u tá»« c Ä‘áº¿n x^{lâˆ’1} vÃ  x^l, sau Ä‘Ã³ tÃ¡i Ä‘iá»u chá»‰nh tá»· lá»‡ cÃ¡c vector Ä‘Ã£ chiáº¿u dá»±a trÃªn Ä‘á»™ lá»›n tÆ°Æ¡ng Ä‘á»‘i cá»§a chÃºng Ä‘á»ƒ khÃ´i phá»¥c chÃ­nh xÃ¡c

---

**HÃ¬nh 3:** Minh há»a phÆ°Æ¡ng phÃ¡p MiniCache Ä‘Æ°á»£c Ä‘á» xuáº¥t. (a) mÃ´ táº£ quÃ¡ trÃ¬nh nÃ©n qua lá»›p. ChÃºng tÃ´i láº¥y cÃ¡c bá»™ nhá»› Ä‘á»‡m KV, tá»« cÃ¡c lá»›p l vÃ  lâˆ’1, vÃ  há»£p nháº¥t chÃºng thÃ nh cÃ¡c tráº¡ng thÃ¡i chia sáº» qua Eq. (3). NgoÃ i ra, chÃºng tÃ´i tÃ­nh norm â„“2 cho cÃ¡c cache Ä‘á»ƒ thu Ä‘Æ°á»£c Ä‘á»™ lá»›n cá»§a chÃºng. HÆ¡n ná»¯a, chÃºng tÃ´i chá»n cÃ¡c token khÃ´ng thá»ƒ há»£p nháº¥t Ä‘á»ƒ giá»¯ láº¡i, sau Ä‘Ã³ lÆ°u trá»¯ cache Ä‘Ã£ há»£p nháº¥t, token giá»¯ láº¡i, vÃ  Ä‘á»™ lá»›n táº¡i lá»›p l trong C. (b) minh há»a quÃ¡ trÃ¬nh khÃ´i phá»¥c cho cÃ¡c lá»›p l vÃ  lâˆ’1, bao gá»“m tÃ¡i Ä‘iá»u chá»‰nh tá»· lá»‡ Ä‘á»™ lá»›n trong Eq. (2) vÃ  khÃ´i phá»¥c token giá»¯ láº¡i.

cÃ¡c tráº¡ng thÃ¡i gá»‘c. Tuy nhiÃªn, phÆ°Æ¡ng phÃ¡p nÃ y yÃªu cáº§u lÆ°u trá»¯ vÃ  tÃ­nh toÃ¡n bá»• sung rá»™ng lá»›n; vÃ­ dá»¥, khÃ´i phá»¥c x^{lâˆ’1} cáº§n cáº£ c vÃ  x^l, Ä‘iá»u nÃ y lÃ m suy yáº¿u lá»£i Ã­ch cá»§a viá»‡c há»£p nháº¥t cache. Äá»ƒ há»£p nháº¥t hiá»‡u quáº£ cÃ¡c cáº·p token, chÃºng tÃ´i láº¥y cáº£m há»©ng tá»« weight normalization [21], phÃ¢n tÃ¡ch cÃ¡c tham sá»‘ mÃ´ hÃ¬nh thÃ nh cÃ¡c thÃ nh pháº§n Ä‘á»™ lá»›n vÃ  hÆ°á»›ng Ä‘á»ƒ tÄƒng tá»‘c sá»± há»™i tá»¥ cá»§a gradient descent ngáº«u nhiÃªn. NgoÃ i ra, chÃºng tÃ´i láº¥y gá»£i Ã½ tá»« DoRA [72], sá»­ dá»¥ng cÃ¡ch tÆ°Æ¡ng tá»± Ä‘á»ƒ giá»‘ng hÃ nh vi há»c cá»§a fine-tuning hiá»‡u quáº£ tham sá»‘ so vá»›i full fine-tuning. Trong trÆ°á»ng há»£p cá»§a chÃºng tÃ´i, tÃ¡i tham sá»‘ hÃ³a cÃ³ thá»ƒ Ä‘Æ°á»£c cÃ´ng thá»©c hÃ³a nhÆ° sau:

xÌ‚^l = e^{l,lâˆ’1} Â· ||x^l|| / ||e^{l,lâˆ’1}||, xÌ‚^{lâˆ’1} = e^{l,lâˆ’1} Â· ||x^{lâˆ’1}|| / ||e^{l,lâˆ’1}||, (2)

trong Ä‘Ã³ e lÃ  vector hÆ°á»›ng. Viá»‡c phÃ¢n tÃ¡ch nÃ y Ä‘áº£m báº£o ráº±ng e^{l,lâˆ’1}/||e^{l,lâˆ’1}|| lÃ  má»™t vector Ä‘Æ¡n vá»‹, vÃ  cho phÃ©p cÃ¡c tráº¡ng thÃ¡i Ä‘Æ°á»£c khÃ´i phá»¥c khá»›p vá»›i norm â„“2 cá»§a cÃ¡c tráº¡ng thÃ¡i gá»‘c, tá»« Ä‘Ã³ báº£o tá»“n thÃ´ng tin cá»§a cache cÃ ng nhiá»u cÃ ng tá»‘t. QuÃ¡ trÃ¬nh khÃ´i phá»¥c Ä‘Æ°á»£c hiá»ƒn thá»‹ nhÆ° HÃ¬nh 3(b). Äá»ƒ ngáº¯n gá»n, chÃºng tÃ´i bá» qua cÃ¡c chá»‰ sá»‘ dÆ°á»›i k vÃ  v, vÃ¬ key vÃ  value Ä‘Æ°á»£c phÃ¢n tÃ¡ch theo cÃ¹ng má»™t cÃ¡ch. Äá»ƒ Æ°á»›c tÃ­nh thÃ nh pháº§n hÆ°á»›ng e^{l,lâˆ’1}, chÃºng tÃ´i theo SLERP [64], xá»­ lÃ½ thÃ­ch á»©ng viá»‡c ná»™i suy, thÆ°á»ng giá»‘ng cÃ¡c biáº¿n Ä‘á»•i giá»‘ng xoay. Viá»‡c chá»n SLERP lÃ m hÃ m há»£p nháº¥t lÃ  chiáº¿n lÆ°á»£c, vÃ¬ nÃ³ táº¡o Ä‘iá»u kiá»‡n cho viá»‡c ná»™i suy dá»c theo Ä‘Æ°á»ng dáº«n ngáº¯n nháº¥t trÃªn máº·t cáº§u Ä‘Æ¡n vá»‹ giá»¯a hai vector chiá»u cao, tá»« Ä‘Ã³ báº£o tá»“n tÃ­nh toÃ n váº¹n hÃ¬nh há»c cá»§a chÃºng, Ä‘iá»u nÃ y Ä‘á» cáº­p Ä‘áº¿n thao tÃ¡c há»£p nháº¥t trong HÃ¬nh 3(a). Äiá»u nÃ y ráº¥t quan trá»ng Ä‘á»ƒ duy trÃ¬ cÃ¡c tÃ­nh cháº¥t ngá»¯ nghÄ©a vÃ  cÃº phÃ¡p cá»§a cÃ¡c bá»™ nhá»› Ä‘á»‡m KV. CÃ´ng thá»©c cho SLERP trong ngá»¯ cáº£nh cá»§a chÃºng tÃ´i lÃ :

e^{l,lâˆ’1} = sin((1âˆ’t)Î©^{l,lâˆ’1})/sin(Î©^{l,lâˆ’1}) Â· x^{lâˆ’1}/||x^{lâˆ’1}|| + sin(tÎ©^{l,lâˆ’1})/sin(Î©^{l,lâˆ’1}) Â· x^l/||x^l||, (3)

trong Ä‘Ã³ Î©^{l,lâˆ’1} = arccos(x^lÂ·x^{lâˆ’1}/(||x^l||||x^{lâˆ’1}||)) biá»ƒu thá»‹ gÃ³c giá»¯a cÃ¡c vector x^l vÃ  x^{lâˆ’1}, vÃ  sin(Â·) lÃ  hÃ m sine. t lÃ  má»™t siÃªu tham sá»‘ ná»™i suy Ä‘iá»u chá»‰nh áº£nh hÆ°á»Ÿng tÆ°Æ¡ng Ä‘á»‘i cá»§a má»—i vector Ä‘áº¿n hÆ°á»›ng káº¿t quáº£, Ä‘Æ°á»£c Ä‘iá»u chá»‰nh theo Ä‘á»™ sÃ¢u lá»›p vÃ  cÃ¡c Ä‘áº·c Ä‘iá»ƒm cá»¥ thá»ƒ cá»§a cÃ¡c cáº·p KV. LÆ°u Ã½ ráº±ng khi chÃºng tÃ´i Ä‘áº·t t = 0.5, nÃ³ sáº½ trá»Ÿ thÃ nh há»£p nháº¥t trung bÃ¬nh dá»c theo bá» máº·t hÃ¬nh há»c, mÃ  chÃºng tÃ´i coi lÃ  trÆ°á»ng há»£p Ä‘áº·c biá»‡t trong Eq. (A). Cache Ä‘Ã£ há»£p nháº¥t cho má»—i cáº·p token sau Ä‘Ã³ lÃ  má»™t concatenation cá»§a vector hÆ°á»›ng, Ä‘á»™ lá»›n vÃ  Î©^{l,lâˆ’1}, Ä‘Æ°á»£c kÃ½ hiá»‡u lÃ  c^{l,lâˆ’1} = [e^{l,lâˆ’1}, ||x^{lâˆ’1}||, ||x^l||, Î©^{l,lâˆ’1}], cÃ¡c thÃ nh pháº§n Ä‘Æ°á»£c cache nhÆ° Ä‘Æ°á»£c hiá»ƒn thá»‹ trong HÃ¬nh 3(a). LÆ°u Ã½ ráº±ng ngoÃ i viá»‡c lÆ°u trá»¯ vector hÆ°á»›ng Ä‘Ã£ há»£p nháº¥t, chÃºng tÃ´i chá»‰ cáº§n lÆ°u trá»¯ Ä‘á»™ lá»›n theo token bá»• sung vÃ  cÃ¡c scalar gÃ³c, Ä‘iá»u nÃ y hiá»‡u quáº£ vá» bá»™ nhá»›. Báº±ng cÃ¡ch nÃ y, chÃºng tÃ´i Ä‘áº¡t Ä‘Æ°á»£c hiá»‡u quáº£ bá»™ nhá»› Ä‘Ã¡ng ká»ƒ thÃ´ng qua giáº£m sá»± dÆ° thá»«a trong khi Ä‘áº£m báº£o viá»‡c giá»¯ láº¡i cÃ¡c Ä‘áº·c Ä‘iá»ƒm chá»©c nÄƒng quan trá»ng cá»§a cÃ¡c cáº·p KV gá»‘c qua cÃ¡c lá»›p transformer.

**Giá»¯ láº¡i token khÃ´ng thá»ƒ há»£p nháº¥t.** CÃ¡c cáº·p khÃ¡c biá»‡t cao nháº¡y cáº£m vá»›i cÃ¡c thao tÃ¡c há»£p nháº¥t, dáº«n chÃºng tÃ´i Ä‘á» xuáº¥t giá»¯ láº¡i token khÃ´ng thá»ƒ há»£p nháº¥t, nhÆ° Ä‘Æ°á»£c hiá»ƒn thá»‹ trong HÃ¬nh 3(a). Máº·c dÃ¹ cÃ³ Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng cao giá»¯a cÃ¡c tráº¡ng thÃ¡i bá»™ nhá»› Ä‘á»‡m KV qua cÃ¡c lá»›p lÃ¡ng giá»ng, má»™t sá»‘ cáº·p khÃ¡c biá»‡t nháº¡y cáº£m váº«n cÃ²n láº¡i lÃ  khÃ³ há»£p nháº¥t vÃ  chia sáº» Ä‘Ã¡ng ká»ƒ. PhÃ¹ há»£p vá»›i cÃ¡c nghiÃªn cá»©u trÆ°á»›c, nhá»¯ng token khÃ¡c biá»‡t nÃ y mang Ã½ nghÄ©a ngá»¯ nghÄ©a Ä‘Ã¡ng ká»ƒ [15,16]. ChÃºng tÃ´i quan sÃ¡t ráº±ng viá»‡c há»£p nháº¥t cÃ¡c token nháº¡y cáº£m, dáº«n Ä‘áº¿n máº¥t thÃ´ng tin cá»¥ thá»ƒ theo lá»›p, cÃ³ thá»ƒ dáº«n Ä‘áº¿n suy giáº£m hiá»‡u nÄƒng Ä‘Ã¡ng ká»ƒ. Do Ä‘Ã³, viá»‡c tÃ¡ch riÃªng Ä‘Ãºng cÃ¡ch thÃ´ng tin Ä‘Æ°á»£c chia sáº» vÃ  duy nháº¥t giá»¯a cÃ¡c lá»›p liá»n ká» lÃ  ráº¥t quan trá»ng. Äá»ƒ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y, chÃºng tÃ´i thiáº¿t káº¿ má»™t chiáº¿n lÆ°á»£c giá»¯ láº¡i token Ä‘á»ƒ chá»n lá»c giá»¯ láº¡i cÃ¡c token khÃ´ng thá»ƒ há»£p nháº¥t dá»±a trÃªn khoáº£ng cÃ¡ch gÃ³c cá»§a chÃºng, Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a lÃ : d(x^l, x^{lâˆ’1}) = 1/Ï€ Î©. Äá»‘i vá»›i cÃ¡c bá»™ nhá»› Ä‘á»‡m KV, khoáº£ng cÃ¡ch gÃ³c tá»‘i thiá»ƒu vÃ  tá»‘i Ä‘a Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh Ä‘á»ƒ nháº­n dáº¡ng cÃ¡c token khÃ´ng thá»ƒ há»£p nháº¥t.

Táº­p há»£p cÃ¡c chá»‰ sá»‘ token cáº§n thiáº¿t Ä‘á»ƒ giá»¯, I, Ä‘Æ°á»£c thu Ä‘Æ°á»£c bá»Ÿi:

I = {i|d_i < d_{min} + (d_{max} âˆ’ d_{min}) Â· Î³}, (4)

trong Ä‘Ã³ Î³ lÃ  má»™t siÃªu tham sá»‘ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trÆ°á»›c Ä‘iá»u khiá»ƒn ngÆ°á»¡ng giá»¯ láº¡i. CÃ¡c token vá»›i chá»‰ sá»‘ trong I Ä‘Æ°á»£c giá»¯ láº¡i vÃ  khÃ´ng bá»‹ nÃ©n trong quÃ¡ trÃ¬nh há»£p nháº¥t, Ä‘iá»u nÃ y Ä‘áº£m báº£o ráº±ng hiá»‡u nÄƒng khÃ´ng giáº£m báº±ng cÃ¡ch ngÄƒn cháº·n máº¥t cÃ¡c token khÃ´ng thá»ƒ há»£p nháº¥t.

Tiáº¿p theo, Ä‘áº·t X âˆˆ R^{nÃ—h} lÃ  cache key hoáº·c value táº¡i má»™t lá»›p attention, trong Ä‘Ã³ n biá»ƒu thá»‹ sá»‘ lÆ°á»£ng token vÃ  h lÃ  sá»‘ chiá»u áº©n, vÃ  E âˆˆ R^{nÃ—h} lÃ  cÃ¡c tráº¡ng thÃ¡i bá»™ nhá»› Ä‘á»‡m KV chia sáº». Äá»‘i vá»›i má»—i cáº·p hai lá»›p lÃ¡ng giá»ng, cÃ¡c token khÃ´ng thá»ƒ há»£p nháº¥t Ä‘Æ°á»£c chá»n cÃ¹ng vá»›i chiá»u token bá»Ÿi R^l = X^l[I], R^{lâˆ’1} = X^{lâˆ’1}[I], sau Ä‘Ã³ khÃ´i phá»¥c thÃ nh cÃ¡c cache nÃ©n cá»§a chÃºng tÃ´i bá»Ÿi XÌ‚^l[I] = R^l, XÌ‚^{lâˆ’1}[I] = R^{lâˆ’1}, nhÆ° Ä‘Æ°á»£c hiá»ƒn thá»‹ trong HÃ¬nh 3(b). Tá»•ng thá»ƒ, chÃºng tÃ´i chia sáº» cache cuá»‘i cÃ¹ng cho hai lá»›p lÃ  C^{l,lâˆ’1} = [E^{l,lâˆ’1}, R^l, R^{lâˆ’1}, ||X^{lâˆ’1}||, ||X^l||, I]. Cache nÃ y bao gá»“m cÃ¡c tráº¡ng thÃ¡i bá»™ nhá»› Ä‘á»‡m KV chia sáº», giá»¯ láº¡i cÃ¡c token chÆ°a há»£p nháº¥t, vector Ä‘á»™ lá»›n cho má»—i lá»›p, vÃ  chá»‰ sá»‘ giá»¯ token, tÆ°Æ¡ng á»©ng. Nhá»¯ng thÃ nh pháº§n bá»• sung nÃ y khÃ¡ nháº¹. Do Ä‘Ã³ so vá»›i cache full-layer, phÆ°Æ¡ng phÃ¡p cá»§a chÃºng tÃ´i váº«n hiá»‡u quáº£ vá» bá»™ nhá»›, nhÆ° Ä‘Æ°á»£c tháº£o luáº­n trong Sec. 4.3.

**KhÃ´i phá»¥c cache.** Sau khi thu Ä‘Æ°á»£c cache chia sáº» C^{l,lâˆ’1}, chÃºng tÃ´i cáº§n khÃ´i phá»¥c xáº¥p xá»‰ cÃ¡c tráº¡ng thÃ¡i cache gá»‘c cho viá»‡c decoding token hiá»‡n táº¡i, nhÆ° Ä‘Æ°á»£c hiá»ƒn thá»‹ trong Fig. 3(b). Cá»¥ thá»ƒ, Ä‘á»ƒ khÃ´i phá»¥c X^l, trÆ°á»›c tiÃªn chÃºng tÃ´i tÃ¡i Ä‘iá»u chá»‰nh tá»· lá»‡ cÃ¡c tráº¡ng thÃ¡i chia sáº» hÆ°á»›ng vá»›i vector Ä‘á»™ lá»›n tÆ°Æ¡ng á»©ng dá»c theo chiá»u token, Ä‘Æ°á»£c kÃ½ hiá»‡u lÃ  E^{l,lâˆ’1}||X^l||. Sau Ä‘Ã³, chÃºng tÃ´i thá»±c hiá»‡n khÃ´i phá»¥c token giá»¯ láº¡i báº±ng cÃ¡ch Ä‘áº·t cÃ¡c token nháº¡y cáº£m theo chá»‰ sá»‘ token cá»§a chÃºng.

### 4.3 Tháº£o luáº­n vá» hiá»‡u quáº£

**Hiá»‡u quáº£ nÃ©n.** ChÃºng tÃ´i chá»§ yáº¿u phÃ¢n tÃ­ch hiá»‡u quáº£ bá»™ nhá»› cá»§a chÃºng tÃ´i vá» sá»‘ lÆ°á»£ng token Ä‘Æ°á»£c sá»­ dá»¥ng. Tiáº¿p theo, Ä‘áº·t r lÃ  sá»‘ lÆ°á»£ng lá»›p vÃ  b lÃ  kÃ­ch thÆ°á»›c batch, s vÃ  n lÃ  Ä‘á»™ dÃ i chuá»—i Ä‘áº§u vÃ o vÃ  Ä‘áº§u ra tÆ°Æ¡ng á»©ng. ChÃºng tÃ´i xem xÃ©t lÆ°u trá»¯ FP16 cho bá»™ nhá»› Ä‘á»‡m KV. Viá»‡c sá»­ dá»¥ng bá»™ nhá»› cache Ä‘áº§y Ä‘á»§ Ä‘Æ°á»£c cho bá»Ÿi 4brh(s+n). Trong nghiÃªn cá»©u cá»§a chÃºng tÃ´i, chÃºng tÃ´i báº¯t Ä‘áº§u há»£p nháº¥t cÃ¡c lá»›p tá»« giá»¯a Ä‘áº¿n cÃ¡c lá»›p sÃ¢u hÆ¡n, há»£p nháº¥t cÃ¡c tráº¡ng thÃ¡i bá»™ nhá»› Ä‘á»‡m KV cá»§a má»—i hai lá»›p thÃ nh má»™t khÃ´ng gian tráº¡ng thÃ¡i chia sáº» duy nháº¥t. Káº¿t quáº£ lÃ , chÃºng tÃ´i hiá»‡u quáº£ giáº£m viá»‡c sá»­ dá»¥ng bá»™ nhá»› GPU trong suy luáº­n decoding xuá»‘ng 3brh(s+n), chá»©ng minh tá»· lá»‡ nÃ©n Ä‘Ã¡ng ká»ƒ.

**Hiá»‡u quáº£ khÃ´i phá»¥c.** Sau Ä‘Ã³ chÃºng tÃ´i phÃ¢n tÃ­ch chi phÃ­ bá»™ nhá»› bá»• sung phÃ¡t sinh trong quÃ¡ trÃ¬nh khÃ´i phá»¥c, mÃ  Trong giai Ä‘oáº¡n tÃ¡i Ä‘iá»u chá»‰nh tá»· lá»‡ Ä‘á»™ lá»›n, chÃºng tÃ´i lÆ°u má»™t vector norm bá»• sung cho cÃ¡c lá»›p tÆ°Æ¡ng á»©ng trong bá»™ nhá»› Ä‘á»‡m KV. Äiá»u quan trá»ng cáº§n lÆ°u Ã½ lÃ  vector norm cÃ³ dáº¡ng R^{bÃ—sÃ—1}, cÃ³ má»™t chiá»u kÃªnh duy nháº¥t so vá»›i cÃ¡c tráº¡ng thÃ¡i KV gá»‘c full-rank. NgoÃ i ra, chÃºng tÃ´i giáº£ Ä‘á»‹nh ráº±ng ngÆ°á»¡ng giá»¯ láº¡i cÃ³ thá»ƒ Ä‘Æ°á»£c Ä‘áº·t thÃ nh 0.05. Do Ä‘Ã³, chÃºng tÃ´i cÃ³ brh(0.05(s+n)) token Ä‘Æ°á»£c giá»¯ láº¡i mÃ  khÃ´ng nÃ©n. Cuá»‘i cÃ¹ng, yÃªu cáº§u bá»™ nhá»› tá»•ng thá»ƒ cá»§a chÃºng tÃ´i Ä‘Æ°á»£c cho bá»Ÿi (3.1h + 2)br(s+n). Viá»‡c dáº«n xuáº¥t chi tiáº¿t Ä‘Æ°á»£c hiá»ƒn thá»‹ trong Phá»¥ lá»¥c E.

## 5 ThÃ­ nghiá»‡m

ChÃºng tÃ´i chá»©ng minh ráº±ng MiniCache cá»§a chÃºng tÃ´i cÃ³ thá»ƒ thá»±c hiá»‡n nÃ©n há»£p nháº¥t trÃªn ná»­a sau cá»§a cÃ¡c lá»›p LLM vá»›i suy giáº£m hiá»‡u nÄƒng tá»‘i thiá»ƒu.

**Chi tiáº¿t triá»ƒn khai.** CÃ¡c thÃ­ nghiá»‡m cá»§a chÃºng tÃ´i dá»±a trÃªn cÃ¡c há» mÃ´ hÃ¬nh Ä‘áº¡i diá»‡n cá»§a LLM, bao gá»“m má»™t LLM nhá» gá»n Phi-3-Mini [23] vÃ  má»™t LLM MoE Mixtral-8x7B [22]. NgoÃ i ra, chÃºng tÃ´i Ã¡p dá»¥ng cÃ¡c mÃ´ hÃ¬nh LLaMA-3 [6] 8B vÃ  70B Ä‘á»ƒ khÃ¡m phÃ¡ cÃ¡ch phÆ°Æ¡ng phÃ¡p cá»§a chÃºng tÃ´i tá»•ng quÃ¡t hÃ³a cho cÃ¡c LLM lá»›n hÆ¡n. ChÃºng tÃ´i láº¥y máº«u mÆ°á»i nhiá»‡m vá»¥ tá»« lm-eval-harness [32], bao gá»“m COPA [24], MathQA [25], OpenBookQA [26], PIQA [27], RTE [28], WinoGrande [29], XSUM [30], vÃ  CNN/Daily Mail [31]. ChÃºng tÃ´i cÅ©ng Ä‘Ã¡nh giÃ¡ viá»‡c táº¡o chuá»—i dÃ i trÃªn LongBench [33]. ChÃºng tÃ´i so sÃ¡nh phÆ°Æ¡ng phÃ¡p cá»§a mÃ¬nh vá»›i má»™t baseline cache Ä‘áº§y Ä‘á»§, vÃ  cÃ¡c phÆ°Æ¡ng phÃ¡p khÃ¡c nhÆ° lÆ°á»£ng tá»­ hÃ³a round-to-nearest (RTN) [73], SmoothQuant [70] vÃ  KIVI [11].

Äá»‘i vá»›i MiniCache Ä‘Æ°á»£c Ä‘á» xuáº¥t, chÃºng tÃ´i Ä‘áº·t tham sá»‘ ná»™i suy t thÃ nh 0.6, chá»‰ ra ráº±ng káº¿t quáº£ Ä‘Ã£ há»£p nháº¥t cÃ³ gÃ³c xoay nhá» hÆ¡n Ä‘áº¿n lá»›p tiáº¿p theo. HÆ¡n ná»¯a, chÃºng tÃ´i Ä‘áº·t ngÆ°á»¡ng giá»¯ láº¡i token Î³ thÃ nh 0.05, theo thá»‘ng kÃª cá»§a cÃ¡c token khÃ´ng thá»ƒ há»£p nháº¥t qua nhiá»u bá»™ dá»¯ liá»‡u. NgoÃ i phÆ°Æ¡ng phÃ¡p há»£p nháº¥t cá»§a chÃºng tÃ´i, chÃºng tÃ´i cÅ©ng xem xÃ©t má»™t baseline máº¡nh cá»§a há»£p nháº¥t trung bÃ¬nh. Äá»ƒ táº£i tuáº§n tá»± cÃ¡c mÃ´ hÃ¬nh lá»›n, chÃºng tÃ´i sá»­ dá»¥ng 4 GPU NVIDIA A100 80GB, chi tiáº¿t thÃªm tham kháº£o Phá»¥ lá»¥c D.

**Káº¿t quáº£ chÃ­nh.** ChÃºng tÃ´i Ä‘Ã¡nh giÃ¡ MiniCache báº±ng cÃ¡ch há»£p nháº¥t cÃ¡c bá»™ nhá»› Ä‘á»‡m KV qua táº¥t cáº£ cÃ¡c lá»›p trÃªn GSM8K, COQA, vÃ  TruthfulQA. Káº¿t quáº£ Ä‘Æ°á»£c hiá»ƒn thá»‹ trong HÃ¬nh 4. NÃ³i chung, chÃºng tÃ´i chá»©ng minh hiá»‡u quáº£ tá»•ng quÃ¡t cá»§a viá»‡c há»£p nháº¥t cÃ¡c bá»™ nhá»› Ä‘á»‡m KV tá»« cÃ¡c lá»›p giá»¯a Ä‘áº¿n sÃ¢u qua cÃ¡c LLM cÃ³ kÃ­ch thÆ°á»›c khÃ¡c nhau. HÆ¡n ná»¯a, MiniCache Ä‘Æ°á»£c Ä‘á» xuáº¥t chá»©ng minh lá»£i tháº¿ nháº¥t quÃ¡n vÃ  Ä‘Ã¡ng ká»ƒ so vá»›i baseline trung bÃ¬nh. ChÃºng tÃ´i cÅ©ng minh há»a hiá»‡u nÄƒng cá»§a viá»‡c há»£p nháº¥t cÃ¡c bá»™ nhá»› Ä‘á»‡m KV qua má»™t ná»­a sá»‘ lá»›p vá»›i cÃ¡c Ä‘Æ°á»ng mÃ u xanh, trong Ä‘Ã³ MiniCache váº«n duy trÃ¬ hiá»‡u nÄƒng máº¡nh máº½ vÃ  Ä‘áº¡t Ä‘Æ°á»£c tá»· lá»‡ nÃ©n tá»‘t nháº¥t. BÃªn cáº¡nh Ä‘Ã³, chÃºng tÃ´i tháº¥y ráº±ng phÆ°Æ¡ng phÃ¡p cá»§a chÃºng tÃ´i tháº­m chÃ­ cÃ²n hiá»‡u quáº£ hÆ¡n Ä‘á»‘i vá»›i cÃ¡c LLM lá»›n hÆ¡n. VÃ­ dá»¥, dá»±a trÃªn LLaMA-3-70B, MiniCache cho tháº¥y gáº§n nhÆ° khÃ´ng cÃ³ sá»¥t giáº£m hiá»‡u nÄƒng ngay cáº£ vá»›i bá»™ nhá»› Ä‘á»‡m KV trong 87.5% cÃ¡c lá»›p Ä‘Æ°á»£c há»£p nháº¥t trÃªn bá»™ dá»¯ liá»‡u COQA. Äiá»u nÃ y nÃªu báº­t tÃ­nh thÃ­ch á»©ng vÃ  hiá»‡u quáº£ cá»§a phÆ°Æ¡ng phÃ¡p chÃºng tÃ´i trong viá»‡c xá»­ lÃ½ cÃ¡c mÃ´ hÃ¬nh quy mÃ´ lá»›n trong khi Ä‘áº£m báº£o suy giáº£m hiá»‡u nÄƒng tá»‘i thiá»ƒu.

**LongBench.** ChÃºng tÃ´i cÅ©ng tiáº¿n hÃ nh thÃ­ nghiá»‡m Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ hiá»‡u nÄƒng vÃ  cháº¥t lÆ°á»£ng trong viá»‡c táº¡o chuá»—i dÃ i sá»­ dá»¥ng bá»™ dá»¯ liá»‡u LongBench [33], nhÆ° Ä‘Æ°á»£c hiá»ƒn thá»‹ trong Báº£ng 1. CÃ¡c thÃ­ nghiá»‡m cá»§a chÃºng tÃ´i Ã¡p dá»¥ng MiniCache trÃªn má»™t sá»‘ mÃ´ hÃ¬nh: LLaMA-2-7B-Chat, LLaMA-2-13B-Chat, Mistral-7B, vÃ  Mistral-7B-Instruct. Äiá»u quan trá»ng cáº§n lÆ°u Ã½ lÃ  phÆ°Æ¡ng phÃ¡p MiniCache cá»§a chÃºng tÃ´i duy trÃ¬ tÃ­nh trá»±c giao vá»›i táº¥t cáº£ cÃ¡c phÆ°Æ¡ng phÃ¡p lÆ°á»£ng tá»­ hÃ³a vÃ  thÆ°a thá»›t hiá»‡n cÃ³ (tham kháº£o Báº£ng A) á»Ÿ cáº£ cáº¥p Ä‘á»™ mÃ´ hÃ¬nh vÃ  token-wise. Khi káº¿t há»£p vá»›i lÆ°á»£ng tá»­ hÃ³a bá»™ nhá»› Ä‘á»‡m KV KIVI-4bit, phÆ°Æ¡ng phÃ¡p cá»§a chÃºng tÃ´i Ä‘áº¡t Ä‘Æ°á»£c tá»· lá»‡ nÃ©n 5.02Ã—, vá»›i tÃ¡c Ä‘á»™ng tá»‘i thiá»ƒu Ä‘áº¿n Ä‘á»™ chÃ­nh xÃ¡c qua cÃ¡c nhiá»‡m vá»¥ táº¡o ngá»¯ cáº£nh dÃ i thÃ¡ch thá»©c khÃ¡c nhau. Sá»± káº¿t há»£p cá»§a MiniCache vÃ  lÆ°á»£ng tá»­ hÃ³a bá»™ nhá»› Ä‘á»‡m KV KIVI-4bit chá»©ng minh tiáº¿t kiá»‡m bá»™ nhá»› Ä‘Ã¡ng ká»ƒ mÃ  khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n kháº£ nÄƒng cá»§a mÃ´ hÃ¬nh trong viá»‡c xá»­ lÃ½ cÃ¡c chuá»—i dÃ i hiá»‡u quáº£. Äiá»u nÃ y high-

**HÃ¬nh 4:** So sÃ¡nh hiá»‡u nÄƒng giá»¯a MiniCache Ä‘Æ°á»£c Ä‘á» xuáº¥t cá»§a chÃºng tÃ´i vá»›i "baseline trung bÃ¬nh" vÃ  "baseline cache Ä‘áº§y Ä‘á»§ khÃ´ng há»£p nháº¥t" trÃªn nhiá»u bá»™ dá»¯ liá»‡u vá»›i Phi3-Mini, Mixtral-8x7B, LLaMA-3-8B, vÃ  LLaMA-3-70B. Chi tiáº¿t káº¿t quáº£ thÃªm Ä‘Æ°á»£c hiá»ƒn thá»‹ trong Phá»¥ lá»¥c F. Trá»¥c x chá»‰ ra sá»‘ lÆ°á»£ng lá»›p Ä‘Æ°á»£c há»£p nháº¥t. Khi nhiá»u lá»›p hÆ¡n Ä‘Æ°á»£c há»£p nháº¥t, viá»‡c giáº£m sá»­ dá»¥ng bá»™ nhá»› lá»›n hÆ¡n Ä‘Æ°á»£c Ä‘áº¡t Ä‘Æ°á»£c.

---

**Báº£ng 1:** ÄÃ¡nh giÃ¡ cÃ¡c phÆ°Æ¡ng phÃ¡p nÃ©n bá»™ nhá»› Ä‘á»‡m KV khÃ¡c nhau trÃªn LongBench. MiniCache xÃ¢y dá»±ng trÃªn Ä‘áº§u KIVI 4-bit [11] vÃ  Ä‘áº¡t Ä‘Æ°á»£c hiá»‡u nÄƒng tá»‘t nháº¥t vá»›i tá»· lá»‡ nÃ©n máº¡nh nháº¥t.

[Báº£ng Ä‘Æ°á»£c giá»¯ nguyÃªn vá»›i dá»¯ liá»‡u tá»« báº£ng gá»‘c, bao gá»“m cÃ¡c mÃ´ hÃ¬nh Llama-2-7B-Chat, Llama-2-13B-Chat, Mistral-7B, vÃ  Mistral-7B-Instruct vá»›i cÃ¡c phÆ°Æ¡ng phÃ¡p khÃ¡c nhau vÃ  tá»· lá»‡ nÃ©n tÆ°Æ¡ng á»©ng]

lights tiá»m nÄƒng cá»§a phÆ°Æ¡ng phÃ¡p chÃºng tÃ´i Ä‘á»ƒ tá»‘i Æ°u hÃ³a cÃ¡c mÃ´ hÃ¬nh ngÃ´n ngá»¯ lá»›n cho cÃ¡c nhiá»‡m vá»¥ yÃªu cáº§u ngá»¯ cáº£nh rá»™ng lá»›n, lÃ m cho chÃºng hiá»‡u quáº£ vÃ  cÃ³ thá»ƒ má»Ÿ rá»™ng hÆ¡n cho cÃ¡c á»©ng dá»¥ng tháº¿ giá»›i thá»±c.

**PhÃ¢n tÃ­ch hiá»‡u quáº£.** Äá»ƒ Ä‘Ã¡nh giÃ¡ kháº£ nÄƒng tÄƒng tá»‘c cá»§a MiniCache, chÃºng tÃ´i tiáº¿n hÃ nh Ä‘Ã¡nh giÃ¡ dá»±a trÃªn cÃ¡c phÆ°Æ¡ng phÃ¡p Ä‘Æ°á»£c sá»­ dá»¥ng trong vLLM [74] vÃ  KIVI [11]. ChÃºng tÃ´i táº¡o cÃ¡c workload tá»•ng há»£p Ä‘Æ°á»£c dáº«n xuáº¥t tá»« ShareGPT, bao gá»“m vÄƒn báº£n Ä‘áº§u vÃ o vÃ  Ä‘áº§u ra thá»±c tá»« cÃ¡c dá»‹ch vá»¥ LLM. Bá»™ dá»¯ liá»‡u cÃ³ Ä‘á»™ dÃ i prompt Ä‘áº§u vÃ o trung bÃ¬nh lÃ  161 token vÃ  Ä‘á»™ dÃ i Ä‘áº§u ra lÃ  338 token. Sá»­ dá»¥ng mÃ´ hÃ¬nh LLaMA-2-7B trÃªn má»™t GPU NVIDIA A100 80GB duy nháº¥t, chÃºng tÃ´i benchmark phÆ°Æ¡ng phÃ¡p cá»§a mÃ¬nh trong má»™t ká»‹ch báº£n phá»¥c vá»¥ batch, so sÃ¡nh viá»‡c sá»­ dá»¥ng bá»™ nhá»› Ä‘á»‰nh vÃ  thÃ´ng lÆ°á»£ng giá»¯a KIVI 2-bit, MiniCache 4-bit, vÃ  má»™t baseline FP16. NhÆ° Ä‘Æ°á»£c minh há»a trong HÃ¬nh 5, vá»›i kÃ­ch thÆ°á»›c batch lÃ  128, MiniCache giáº£m viá»‡c sá»­ dá»¥ng bá»™ nhá»› 25GB, Ä‘áº¡t Ä‘Æ°á»£c **tiáº¿t kiá»‡m bá»™ nhá»› 41%**. Vá» thÃ´ng lÆ°á»£ng, MiniCache vÆ°á»£t trá»™i hÆ¡n baseline FP16 khoáº£ng **5Ã—**. NgoÃ i ra, máº·c dÃ¹ sá»­ dá»¥ng lÆ°á»£ng tá»­ hÃ³a 4-bit, MiniCache hÆ°á»Ÿng lá»£i tá»« viá»‡c há»£p nháº¥t vÃ  chia sáº» cÃ¡c bá»™ nhá»› Ä‘á»‡m KV qua cÃ¡c lá»›p liá»n ká», dáº«n Ä‘áº¿n thÃ´ng lÆ°á»£ng cao hÆ¡n **1.29Ã—** so vá»›i KIVI 2-bit. Nhá»¯ng káº¿t quáº£ nÃ y chá»©ng minh ráº±ng MiniCache cung cáº¥p sá»± cÃ¢n báº±ng tiÃªn tiáº¿n giá»¯a hiá»‡u quáº£ vÃ  hiá»‡u nÄƒng.

---

**HÃ¬nh 5:** So sÃ¡nh viá»‡c sá»­ dá»¥ng bá»™ nhá»› vÃ  thÃ´ng lÆ°á»£ng giá»¯a MiniCache 4-bit cá»§a chÃºng tÃ´i, KIVI 2-bit, vÃ  Baseline 16-bit. MiniCache cÃ³ thá»ƒ Ä‘áº¡t Ä‘Æ°á»£c thÃ´ng lÆ°á»£ng cao hÆ¡n báº±ng cÃ¡ch cho phÃ©p kÃ­ch thÆ°á»›c batch lá»›n hÆ¡n trong khi giáº£m dung lÆ°á»£ng bá»™ nhá»› qua LLaMA-2-7B [5].

**HÃ¬nh 6:** LLaMA-3-8B [6] Ä‘á»ƒ thÃ­ nghiá»‡m trÃªn GSM8K [10]. Trá»¥c pháº£i lÃ  táº§n suáº¥t chuáº©n hÃ³a cá»§a tá»· lá»‡ Ä‘á»™ lá»›n tÆ°Æ¡ng Ä‘á»‘i. T tÃ¹y chá»n cho tháº¥y tÆ°Æ¡ng quan máº¡nh vá»›i táº§n suáº¥t.

## 6 NghiÃªn cá»©u Ablation

**Báº£ng 2:** So sÃ¡nh cÃ¡c ngÆ°á»¡ng giá»¯ láº¡i token Î³ khÃ¡c nhau bá»Ÿi LLaMA-2-7B [5] trÃªn ba benchmark.

[Báº£ng hiá»ƒn thá»‹ giÃ¡ trá»‹ Î³ tá»« 0 Ä‘áº¿n 1 vá»›i Ä‘iá»ƒm sá»‘ tÆ°Æ¡ng á»©ng trÃªn COQA, GSM8K, vÃ  TruthfulQA]

**TÃ¡c Ä‘á»™ng cá»§a tham sá»‘ diá»…n giáº£i t.** ChÃºng tÃ´i khÃ¡m phÃ¡ tÃ¡c Ä‘á»™ng cá»§a tham sá»‘ diá»…n giáº£i t Ä‘áº¿n hiá»‡u nÄƒng, Ä‘áº·c biá»‡t liÃªn quan Ä‘áº¿n tá»· lá»‡ Ä‘á»™ lá»›n tÆ°Æ¡ng Ä‘á»‘i cá»§a cÃ¡c lá»›p liá»n ká», nhÆ° Ä‘Æ°á»£c hiá»ƒn thá»‹ trong HÃ¬nh 6. ChÃºng tÃ´i giá»¯ táº¥t cáº£ cÃ¡c cÃ i Ä‘áº·t khÃ´ng Ä‘á»•i, báº¯t Ä‘áº§u tá»« lá»›p S = 16 (má»™t ná»­a

---

qua cÃ¡c lá»›p cá»§a LLaMA-3-8B), vÃ  thay Ä‘á»•i tham sá»‘ diá»…n giáº£i t tá»« 0.3 Ä‘áº¿n 0.7. CÃ¡c phÃ¡t hiá»‡n cá»§a chÃºng tÃ´i tiáº¿t lá»™ má»™t sá»‘ Ä‘iá»ƒm quan trá»ng. Khi t = 0.5, quÃ¡ trÃ¬nh giá»‘ng nhÆ° há»£p nháº¥t trung bÃ¬nh, Ã­t hiá»‡u quáº£ hÆ¡n cho viá»‡c há»£p nháº¥t qua lá»›p. NgÆ°á»£c láº¡i, khi t = 0.6 lÃ  tá»‘i Æ°u, biá»ƒu diá»…n Ä‘Ã£ há»£p nháº¥t thá»ƒ hiá»‡n hiá»‡u nÄƒng máº¡nh máº½ nháº¥t, trong khi chá»‰ ra ráº±ng nhiá»u thÃ´ng tin hÆ¡n Ä‘Æ°á»£c dáº«n xuáº¥t tá»« sá»‘ háº¡ng thá»© hai (x^l) cá»§a SLERP.

Káº¿t quáº£ táº§n suáº¥t cÅ©ng chá»‰ ra ráº±ng cÃ¡c táº§n suáº¥t cao Ä‘Æ°á»£c táº­p trung xung quanh 0.4 vÃ  0.6, cá»§ng cá»‘ t tá»‘i Æ°u cá»§a chÃºng tÃ´i. HÆ¡n ná»¯a, cÃ³ tÆ°Æ¡ng quan máº¡nh giá»¯a t tá»‘i Æ°u vÃ  táº§n suáº¥t cao cá»§a tá»· lá»‡ Ä‘á»™ lá»›n tÆ°Æ¡ng Ä‘á»‘i cá»§a cÃ¡c lá»›p liá»n ká». PhÃ¡t hiá»‡n nÃ y cung cáº¥p cÆ¡ há»™i Ä‘á»ƒ sá»­ dá»¥ng tá»· lá»‡ Ä‘á»™ lá»›n tÆ°Æ¡ng Ä‘á»‘i Ä‘á»ƒ xÃ¡c Ä‘á»‹nh Ä‘á»™ng tham sá»‘ diá»…n giáº£i t. t Ä‘á»™ng cho phÃ©p kiá»ƒm soÃ¡t trá»ng sá»‘ linh hoáº¡t hÆ¡n trong há»£p nháº¥t SLERP cho má»—i thao tÃ¡c theo lá»›p, tá»« Ä‘Ã³ cho tháº¥y tiá»m nÄƒng cho viá»‡c khÃ¡m phÃ¡ thÃªm.

**TÃ¡c Ä‘á»™ng cá»§a ngÆ°á»¡ng giá»¯ láº¡i token Î³.** ChÃºng tÃ´i Ä‘iá»u tra tÃ¡c Ä‘á»™ng cá»§a ngÆ°á»¡ng giá»¯ láº¡i token Î³ Ä‘áº¿n hiá»‡u nÄƒng mÃ´ hÃ¬nh qua ba bá»™ dá»¯ liá»‡u, nhÆ° Ä‘Æ°á»£c hiá»ƒn thá»‹ trong Báº£ng 2. Má»™t t lá»›n hÆ¡n thÆ°á»ng cÃ³ nghÄ©a lÃ  giá»¯ láº¡i nhiá»u token hÆ¡n Ä‘á»ƒ cáº£i thiá»‡n hiá»‡u nÄƒng, nhÆ°ng Ä‘iá»u nÃ y Ä‘i kÃ¨m vá»›i chi phÃ­ tÄƒng nhu cáº§u bá»™ nhá»›. Káº¿t quáº£ gá»£i Ã½ ráº±ng viá»‡c Ä‘áº·t Î³ thÃ nh 0.05 Ä‘áº¡t Ä‘Æ°á»£c sá»± cÃ¢n báº±ng tá»‘t nháº¥t giá»¯a hiá»‡u nÄƒng vÃ  hiá»‡u quáº£.

## 7 Káº¿t luáº­n vÃ  CÃ´ng viá»‡c TÆ°Æ¡ng lai

BÃ i bÃ¡o nÃ y trÃ¬nh bÃ y má»™t khÃ¡m phÃ¡ tiÃªn phong vá» nÃ©n bá»™ nhá»› Ä‘á»‡m KV trong chiá»u sÃ¢u, giáº£i quyáº¿t má»™t tháº¯t cá»• chai bá»™ nhá»› Ä‘Ã¡ng ká»ƒ trong LLM. MiniCache Ä‘Æ°á»£c Ä‘á» xuáº¥t cá»§a chÃºng tÃ´i cung cáº¥p má»™t phÆ°Æ¡ng phÃ¡p Ä‘Æ¡n giáº£n, hiá»‡u quáº£ vÃ  khÃ´ng cáº§n huáº¥n luyá»‡n Ä‘á»ƒ nÃ©n cÃ¡c bá»™ nhá»› Ä‘á»‡m KV báº±ng cÃ¡ch táº­n dá»¥ng Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng cao Ä‘Ã¡ng chÃº Ã½ giá»¯a cÃ¡c bá»™ nhá»› Ä‘á»‡m KV trong cÃ¡c lá»›p lÃ¡ng giá»ng, báº¯t Ä‘áº§u tá»« Ä‘iá»ƒm giá»¯a cá»§a LLM. ChÃºng tÃ´i Ä‘Ã£ chá»©ng minh ráº±ng MiniCache cÃ³ thá»ƒ giáº£m Ä‘Ã¡ng ká»ƒ dung lÆ°á»£ng bá»™ nhá»› cáº§n thiáº¿t cho suy luáº­n LLM lÃªn Ä‘áº¿n 41%, Ä‘á»“ng thá»i nÃ¢ng cao thÃ´ng lÆ°á»£ng khoáº£ng nÄƒm láº§n so vá»›i baseline FP16. TÃ³m láº¡i, MiniCache tiáº¿n bá»™ Ä‘Ã¡ng ká»ƒ trong lÄ©nh vá»±c nÃ©n bá»™ nhá»› Ä‘á»‡m KV, cung cáº¥p sá»± cÃ¢n báº±ng tiÃªn tiáº¿n giá»¯a hiá»‡u quáº£ vÃ  hiá»‡u nÄƒng. CÃ´ng viá»‡c tÆ°Æ¡ng lai sáº½ táº­p trung vÃ o viá»‡c nÃ¢ng cao tá»· lá»‡ nÃ©n báº±ng há»£p nháº¥t qua-nhiá»u-lá»›p, phÃ¡t triá»ƒn cÃ¡c thuáº­t toÃ¡n há»£p nháº¥t tiÃªn tiáº¿n nhÆ° Spherical Cubic Interpolation [75], vÃ  tá»‘i Æ°u hÃ³a thÃªm viá»‡c sá»­ dá»¥ng bá»™ nhá»› cho cÃ¡c triá»ƒn khai quy mÃ´ lá»›n trong cÃ¡c ká»‹ch báº£n á»©ng dá»¥ng Ä‘a dáº¡ng.

## TÃ i liá»‡u tham kháº£o

[Danh sÃ¡ch tÃ i liá»‡u tham kháº£o Ä‘Æ°á»£c giá»¯ nguyÃªn vá»›i 81 má»¥c nhÆ° trong báº£n gá»‘c]

---

## Phá»¥ lá»¥c

### A Káº¿t quáº£ ThÃ­ nghiá»‡m Bá»• sung

**So sÃ¡nh vá»›i cÃ¡c phÆ°Æ¡ng phÃ¡p thÆ°a thá»›t token.** ChÃºng tÃ´i cÅ©ng so sÃ¡nh MiniCache vá»›i phÆ°Æ¡ng phÃ¡p dá»±a trÃªn thÆ°a thá»›t H2O [14]. PhÆ°Æ¡ng phÃ¡p cá»§a chÃºng tÃ´i vÆ°á»£t trá»™i hÆ¡n H2O trong háº§u háº¿t cÃ¡c nhiá»‡m vá»¥ trÃªn LongBench. ÄÃ¡ng chÃº Ã½, phÆ°Æ¡ng phÃ¡p cá»§a chÃºng tÃ´i táº­p trung vÃ o viá»‡c giáº£m sá»± dÆ° thá»«a inter-layer, trong khi H2O táº­p trung vÃ o sá»± dÆ° thá»«a intra-layer. CÃ¡c phÆ°Æ¡ng phÃ¡p cá»§a chÃºng tÃ´i trá»±c giao vá»›i cÃ¡c phÆ°Æ¡ng phÃ¡p dá»±a trÃªn thÆ°a thá»›t.

**Báº£ng A:** So sÃ¡nh giá»¯a MiniCache vá»›i phÆ°Æ¡ng phÃ¡p dá»±a trÃªn thÆ°a thá»›t token H2O, sá»­ dá»¥ng mistral-7B-instruct trÃªn bá»™ dá»¯ liá»‡u LongBench.

[Báº£ng chi tiáº¿t vá»›i cÃ¡c phÆ°Æ¡ng phÃ¡p vÃ  Ä‘iá»ƒm sá»‘ tÆ°Æ¡ng á»©ng]

### B CÃ´ng trÃ¬nh liÃªn quan Bá»• sung

**KhÃ¡i niá»‡m cÆ¡ báº£n vá» KV cache trong LLM.** Suy luáº­n LLM Ä‘Ã£ Ä‘Æ°á»£c cáº£i thiá»‡n Ä‘Ã¡ng ká»ƒ trong cÃ¡c cÃ´ng trÃ¬nh gáº§n Ä‘Ã¢y [9,13,74] báº±ng cÃ¡ch tá»‘i Æ°u hÃ³a quáº£n lÃ½ bá»™ nhá»› Ä‘á»‡m KV. Tá»•ng thá»ƒ, dÃ²ng nghiÃªn cá»©u nÃ y thÆ°á»ng Ä‘Æ°á»£c thá»±c hiá»‡n trong hai bÆ°á»›c: 1) Äáº§u tiÃªn, táº¡i giai Ä‘oáº¡n prefilling, LLM tÃ­nh toÃ¡n cÃ¡c bá»™ nhá»› Ä‘á»‡m KV ban Ä‘áº§u táº¡i má»—i lá»›p attention dá»±a trÃªn chuá»—i Ä‘áº§u vÃ o vÃ  decode token Ä‘áº§u tiÃªn. Thá»© hai, 2) táº¡i giai Ä‘oáº¡n decoding, LLM dá»± Ä‘oÃ¡n tá»± há»“i quy token tiáº¿p theo, trong Ä‘Ã³ bá»™ nhá»› Ä‘á»‡m KV cá»§a nÃ³ táº¡i má»—i lá»›p attention Ä‘Æ°á»£c thÃªm vÃ o cÃ¡c cache tá»•ng thá»ƒ. CÃ¡c cÃ´ng trÃ¬nh hiá»‡n cÃ³ Ä‘Ã£ nÃ©n bá»™ nhá»› Ä‘á»‡m KV trong cÃ¡c khÃ­a cáº¡nh khÃ¡c nhau (vÃ­ dá»¥, lÆ°á»£ng tá»­ hÃ³a [11, 12], token pruning [14, 16]).

**NÃ©n KV cache.** Trong nghiÃªn cá»©u trÆ°á»›c, cÃ¡c chiáº¿n lÆ°á»£c khÃ¡c nhau Ä‘á»ƒ nÃ¢ng cao kiáº¿n trÃºc transformer hiá»‡u quáº£ Ä‘Æ°á»£c tháº£o luáº­n, bao gá»“m má»™t phá»• ká»¹ thuáº­t nháº±m tá»‘i Æ°u hÃ³a hiá»‡u nÄƒng vÃ  quáº£n lÃ½ háº¡n cháº¿ tÃ i nguyÃªn. Nhá»¯ng phÆ°Æ¡ng phÃ¡p nÃ y bao gá»“m tá»‘i Æ°u hÃ³a attention [46,47,76], nhÃ³m truy váº¥n [42,43], KV caching thÆ°a thá»›t [16,77,78], thu nhá» token [15,79], vÃ  cáº£i thiá»‡n viá»‡c táº¡o ngá»¯ cáº£nh dÃ i. CÃ¡c Ä‘Ã³ng gÃ³p Ä‘Ã¡ng ká»ƒ Ä‘áº¿n tá»« cÃ¡c dá»± Ã¡n nhÆ° H2O [15], GEAR [15], vÃ  KIVI [11]. NgoÃ i ra, cÃ¡c ná»— lá»±c Ä‘á»ƒ giáº£m thiá»ƒu tháº¯t cá»• chai bá»™ nhá»› Ä‘á»‡m KV bao gá»“m cÃ¡c chiáº¿n lÆ°á»£c nhÆ° multi-query attention [42] vÃ  multi-group attention [43], Ä‘á» xuáº¥t giáº£m sá»‘ lÆ°á»£ng head trong bá»™ nhá»› Ä‘á»‡m KV. Tuy nhiÃªn, nhá»¯ng phÆ°Æ¡ng phÃ¡p nÃ y thÆ°á»ng cáº§n thiáº¿t viá»‡c retrain hoáº·c fine-tune mÃ´ hÃ¬nh. CÃ¡c phÆ°Æ¡ng phÃ¡p khÃ¡c táº­p trung vÃ o viá»‡c giáº£m kÃ­ch thÆ°á»›c cá»§a bá»™ nhá»› Ä‘á»‡m KV báº±ng cÃ¡ch chá»n lá»c loáº¡i bá» cÃ¡c token Ã­t quan trá»ng [14] vÃ  nÃ¢ng cao kiáº¿n trÃºc há»‡ thá»‘ng thÃ´ng qua cÃ¡c cÃ´ng nghá»‡ nhÆ° offloading bá»™ nhá»› Ä‘á»‡m KV [80] hoáº·c tÃ­ch há»£p cÃ¡c ká»¹ thuáº­t nhÆ° bá»™ nhá»› áº£o vÃ  paging [81] vÃ o cÆ¡ cháº¿ attention.

### C Tháº£o luáº­n vÃ  Háº¡n cháº¿

**HÃ m há»£p nháº¥t thay tháº¿.** Trong quÃ¡ trÃ¬nh khÃ¡m phÃ¡ ban Ä‘áº§u cá»§a chÃºng tÃ´i, ban Ä‘áº§u chÃºng tÃ´i xem xÃ©t má»™t hÃ m há»£p nháº¥t thay tháº¿, Ä‘Æ¡n giáº£n hÆ¡n cho nÃ©n qua lá»›p: ná»™i suy báº£o tá»“n norm tá»‘i Ä‘a. HÃ m nÃ y Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ duy trÃ¬ norm tá»‘i Ä‘a cá»§a cÃ¡c vector liÃªn quan, Ä‘áº£m báº£o ráº±ng cÃ¡c Ä‘áº·c Ä‘iá»ƒm quan trá»ng nháº¥t Ä‘Æ°á»£c báº£o tá»“n trong quÃ¡ trÃ¬nh há»£p nháº¥t. Ná»™i suy báº£o tá»“n norm tá»‘i Ä‘a vá» F_max cÃ³ thá»ƒ Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a nhÆ° sau:

F_max(x^l, x^{lâˆ’1}) = xÌ„^{l,lâˆ’1}/||xÌ„^{l,lâˆ’1}|| Â· Max(||x^l||, ||x^{lâˆ’1}||). (A)

á» Ä‘Ã¢y xÌ„^{l,lâˆ’1} biá»ƒu thá»‹ vector trung bÃ¬nh giá»¯a x^l vÃ  x^{lâˆ’1}. HÃ m F_max Ä‘áº£m báº£o ráº±ng vector Ä‘Ã£ há»£p nháº¥t báº£o tá»“n hÆ°á»›ng cá»§a vector trung bÃ¬nh trong khi Ä‘iá»u chá»‰nh tá»· lá»‡ nÃ³ Ä‘áº¿n norm tá»‘i Ä‘a cá»§a cÃ¡c tráº¡ng thÃ¡i KV gá»‘c. So vá»›i hÃ m há»£p nháº¥t dá»±a trÃªn SLERP, F_max cÃ³ chi phÃ­ tÃ­nh toÃ¡n Ã­t hÆ¡n vÃ  tiÃªu thá»¥ bá»™ nhá»› tháº¥p hÆ¡n. Tuy nhiÃªn, nÃ³ Ã­t chÃ­nh xÃ¡c hÆ¡n SLERP. Viá»‡c chá»n giá»¯a sá»­ dá»¥ng F_SLERP hay F_max phá»¥ thuá»™c vÃ o cÃ¡c yÃªu cáº§u cá»¥ thá»ƒ cá»§a á»©ng dá»¥ng. Trong nghiÃªn cá»©u cá»§a chÃºng tÃ´i, chÃºng tÃ´i chá»§ yáº¿u sá»­ dá»¥ng SLERP Ä‘á»ƒ tá»‘i Ä‘a hÃ³a hiá»‡u nÄƒng.

**TÃ¡c Ä‘á»™ng xÃ£ há»™i.** CÃ´ng trÃ¬nh cá»§a chÃºng tÃ´i cho tháº¥y má»™t khÃ¡m phÃ¡ sÆ¡ bá»™ vá» NÃ©n bá»™ nhá»› Ä‘á»‡m KV trong chiá»u sÃ¢u, má»™t lÄ©nh vá»±c tÆ°Æ¡ng Ä‘á»‘i chÆ°a Ä‘Æ°á»£c khÃ¡m phÃ¡ nhÆ°ng cÃ³ tháº¯t cá»• chai quan trá»ng trong cÃ¡c mÃ´ hÃ¬nh ngÃ´n ngá»¯ lá»›n (LLM). MiniCache Ä‘Æ°á»£c Ä‘á» xuáº¥t cung cáº¥p má»™t giáº£i phÃ¡p Ä‘á»ƒ cáº£i thiá»‡n hiá»‡u quáº£ táº¡o LLM vÃ  cÃ³ thá»ƒ thÃ­ch á»©ng vá»›i cÃ¡c cÃ´ng nghá»‡ pruning vÃ  lÆ°á»£ng tá»­ hÃ³a bá»™ nhá»› Ä‘á»‡m KV dá»±a trÃªn intra-layer hiá»‡n cÃ³. NgoÃ i ra, chÃºng tÃ´i Ä‘á» xuáº¥t má»™t phÆ°Æ¡ng phÃ¡p Ä‘Æ¡n giáº£n nhÆ°ng hiá»‡u quáº£ há»£p nháº¥t cÃ¡c tráº¡ng thÃ¡i bá»™ nhá»› Ä‘á»‡m KV tÆ°Æ¡ng tá»± theo cÃ¡ch qua lá»›p vÃ  hiá»‡u quáº£ khÃ´i phá»¥c hiá»‡u nÄƒng thÃ´ng qua má»™t ká»¹ thuáº­t khÃ´i phá»¥c má»›i. CÃ¡c quan sÃ¡t cá»§a chÃºng tÃ´i chá»‰ ra ráº±ng Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng vÃ  kháº£ nÄƒng há»£p nháº¥t qua lá»›p cÃ³ thá»ƒ Ä‘Æ°á»£c Ã¡p dá»¥ng trong cÃ¡c á»©ng dá»¥ng hiá»‡u quáº£ rá»™ng rÃ£i cho tá»‘i Æ°u hÃ³a sau huáº¥n luyá»‡n trong cÃ¡c ká»‹ch báº£n tÃ i nguyÃªn tháº¥p, nhÆ° triá»ƒn khai trÃªn thiáº¿t bá»‹ di Ä‘á»™ng. HÆ¡n ná»¯a, vá»›i tá»‘i Æ°u hÃ³a hiá»‡u quáº£ nhu cáº§u bá»™ nhá»› bá»™ nhá»› Ä‘á»‡m KV, MiniCache nÃ¢ng cao hÆ¡n ná»¯a viá»‡c táº¡o ngá»¯ cáº£nh dÃ i, Ä‘Ã¢y lÃ  má»™t mÃ´ hÃ¬nh quan trá»ng cho cÃ¡c á»©ng dá»¥ng tháº¿ giá»›i thá»±c, nhÆ° hiá»ƒu cÃ¡c khÃ¡i niá»‡m trong sÃ¡ch giÃ¡o khoa. ChÃºng tÃ´i hÆ°á»›ng Ä‘áº¿n viá»‡c cÃ´ng trÃ¬nh cá»§a mÃ¬nh thÃºc Ä‘áº©y ranh giá»›i cá»§a hai thÃ¡ch thá»©c chÃ­nh trong ngÃ nh vÃ  nghiÃªn cá»©u LLM: suy luáº­n batch vÃ  táº¡o ngá»¯ cáº£nh dÃ i.

HÆ¡n ná»¯a, ngoÃ i cÃ¡c Ä‘Ã³ng gÃ³p Ä‘Ã¡ng ká»ƒ cá»§a MiniCache cho NÃ©n bá»™ nhá»› Ä‘á»‡m KV, má»™t sá»‘ thÃ¡ch thá»©c váº«n cÃ²n chung cho LLM. CÃ¡c váº¥n Ä‘á» nhÆ° tÃ­nh trung thá»±c vÃ  báº£o máº­t cá»§a LLM váº«n chÆ°a Ä‘Æ°á»£c giáº£i quyáº¿t. Äáº£m báº£o Ä‘á»™ chÃ­nh xÃ¡c vÃ  Ä‘á»™ tin cáº­y cá»§a ná»™i dung Ä‘Æ°á»£c táº¡o lÃ  quan trá»ng, vÃ¬ LLM Ä‘Ã´i khi cÃ³ thá»ƒ táº¡o ra thÃ´ng tin há»£p lÃ½ nhÆ°ng khÃ´ng chÃ­nh xÃ¡c hoáº·c gÃ¢y hiá»ƒu láº§m. NgoÃ i ra, báº£o vá»‡ chá»‘ng láº¡i cÃ¡c lá»— há»•ng báº£o máº­t, nhÆ° táº¥n cÃ´ng Ä‘á»‘i nghá»‹ch hoáº·c rÃ² rá»‰ dá»¯ liá»‡u, lÃ  tá»‘i quan trá»ng Ä‘á»ƒ duy trÃ¬ tÃ­nh toÃ n váº¹n vÃ  báº£o máº­t cá»§a cÃ¡c tÆ°Æ¡ng tÃ¡c ngÆ°á»i dÃ¹ng. Giáº£i quyáº¿t nhá»¯ng thÃ¡ch thá»©c nÃ y yÃªu cáº§u nghiÃªn cá»©u vÃ  phÃ¡t triá»ƒn liÃªn tá»¥c Ä‘á»ƒ nÃ¢ng cao tÃ­nh máº¡nh máº½ vÃ  Ä‘Ã¡ng tin cáº­y cá»§a LLM. Ná»— lá»±c nÃ y pháº£i tiáº¿n hÃ nh cÃ¹ng vá»›i nhá»¯ng tiáº¿n bá»™ trong hiá»‡u quáº£ tÃ­nh toÃ¡n vÃ  hiá»‡u nÄƒng, nhÆ° Ä‘Æ°á»£c minh há»a bá»Ÿi cÃ¡c Ä‘á»•i má»›i nhÆ° MiniCache.

**Háº¡n cháº¿.** Thuáº­t toÃ¡n há»£p nháº¥t hiá»‡n táº¡i dá»±a trÃªn Spherical Linear Interpolation (SLERP) cÃ³ nhá»¯ng háº¡n cháº¿ cá»§a nÃ³. SLERP chá»‰ phÃ¹ há»£p Ä‘á»ƒ há»£p nháº¥t hai vector vÃ  sá»­ dá»¥ng phÆ°Æ¡ng phÃ¡p ná»™i suy háº¡n cháº¿ thuáº­t toÃ¡n cá»§a chÃºng tÃ´i khá»i viá»‡c há»£p nháº¥t nhiá»u lá»›p Ä‘á»“ng thá»i vÃ  tá»‘i Ä‘a hÃ³a tá»· lá»‡ nÃ©n trong cÃ¡c tráº¡ng thÃ¡i sÃ¢u hÆ¡n. Háº¡n cháº¿ nÃ y áº£nh hÆ°á»Ÿng Ä‘áº¿n hiá»‡u quáº£ tá»•ng thá»ƒ cá»§a nÃ©n bá»™ nhá»› Ä‘á»‡m KV vÃ  nháº¥n máº¡nh nhu cáº§u vá» cÃ¡c ká»¹ thuáº­t tiÃªn tiáº¿n cÃ³ kháº£ nÄƒng xá»­ lÃ½ cÃ¡c ká»‹ch báº£n há»£p nháº¥t phá»©c táº¡p hÆ¡n. NghiÃªn cá»©u tÆ°Æ¡ng lai nÃªn táº­p trung vÃ o viá»‡c phÃ¡t triá»ƒn cÃ¡c thuáº­t toÃ¡n tinh vi hÆ¡n cÃ³ thá»ƒ vÆ°á»£t qua nhá»¯ng háº¡n cháº¿ nÃ y, tá»« Ä‘Ã³ nÃ¢ng cao kháº£ nÄƒng nÃ©n vÃ  hiá»‡u nÄƒng tá»•ng thá»ƒ cá»§a LLM.

### D Chi tiáº¿t Triá»ƒn khai Bá»• sung

**Tá»•ng quan vá» thuáº­t toÃ¡n suy luáº­n.** Viá»‡c triá»ƒn khai suy luáº­n MiniCache, nhÆ° Ä‘Æ°á»£c hiá»ƒn thá»‹ trong Alg. 1, bao gá»“m má»™t sá»‘ bÆ°á»›c chÃ­nh. Khi giao diá»‡n báº¯t Ä‘áº§u, Trong giai Ä‘oáº¡n prefilling, chÃºng tÃ´i Ä‘á»‹nh nghÄ©a lá»›p báº¯t Ä‘áº§u há»£p nháº¥t S. TrÆ°á»›c khi Ä‘áº¡t Ä‘áº¿n lá»›p S, suy luáº­n sá»­ dá»¥ng logic attention vÃ  cache gá»‘c. Tá»« lá»›p S trá»Ÿ Ä‘i, chÃºng tÃ´i triá»ƒn khai thuáº­t toÃ¡n há»£p nháº¥t cá»§a mÃ¬nh, hoáº¡t Ä‘á»™ng theo cÃ¡ch qua lá»›p vÃ  chá»‰ Ä‘Æ°á»£c Ã¡p dá»¥ng táº¡i cÃ¡c lá»›p sá»‘ láº». Trong quÃ¡ trÃ¬nh há»£p nháº¥t, chÃºng tÃ´i láº¥y bá»™ nhá»› Ä‘á»‡m KV tá»« lá»›p trÆ°á»›c vÃ  lÆ°u cÃ¡c tráº¡ng thÃ¡i chia sáº» Ä‘Ã£ há»£p nháº¥t vÃ o bá»™ nhá»› Ä‘á»‡m KV cá»§a lá»›p hiá»‡n táº¡i. Äá»ƒ giáº£m viá»‡c sá»­ dá»¥ng bá»™ nhá»›, sau Ä‘Ã³ chÃºng tÃ´i loáº¡i bá» cache cá»§a lá»›p trÆ°á»›c. NgoÃ i ra, chÃºng tÃ´i lÆ°u trá»¯ vector Ä‘á»™ lá»›n vÃ  token nháº¡y cáº£m giá»¯ láº¡i cho má»—i lá»›p. Trong giai Ä‘oáº¡n decoding, hai ká»‹ch báº£n xuáº¥t hiá»‡n sau lá»›p S. Äá»‘i vá»›i cÃ¡c lá»›p sá»‘ cháºµn (vÃ²ng Ä‘áº§u tiÃªn), vÃ¬ bá»™ nhá»› Ä‘á»‡m KV Ä‘Ã£ bá»‹ loáº¡i bá» trong giai Ä‘oáº¡n prefilling, chÃºng tÃ´i tham kháº£o lá»›p tiáº¿p theo (l + 1) Ä‘á»ƒ láº¥y cÃ¡c tráº¡ng thÃ¡i bá»™ nhá»› Ä‘á»‡m KV chia sáº». Sau Ä‘Ã³ chÃºng tÃ´i thá»±c hiá»‡n khÃ´i phá»¥c tá»· lá»‡ xáº¥p xá»‰ vÃ  khÃ´i phá»¥c token giá»¯ láº¡i. CÃ¡c tráº¡ng thÃ¡i KV má»›i tá»« giai Ä‘oáº¡n nÃ y Ä‘Æ°á»£c lÆ°u trá»¯ Ä‘á»ƒ sá»­ dá»¥ng trong vÃ²ng tiáº¿p theo. Trong vÃ²ng thá»© hai, bao gá»“m cÃ¡c lá»›p sá»‘ láº», chÃºng tÃ´i sá»­ dá»¥ng cÃ¡c token KV má»›i tá»« cáº£ lá»›p trÆ°á»›c vÃ  hiá»‡n táº¡i. Sau giai Ä‘oáº¡n khÃ´i phá»¥c, chÃºng tÃ´i thá»±c hiá»‡n cÃ¡c thao tÃ¡c há»£p nháº¥t vÃ  cáº­p nháº­t cÃ¡c tráº¡ng thÃ¡i bá»™ nhá»› Ä‘á»‡m KV chia sáº» trong stack.

**Thuáº­t toÃ¡n há»£p nháº¥t vÃ  khÃ´i phá»¥c qua lá»›p.** NhÆ° Ä‘Æ°á»£c nÃªu trong Alg. 2, thuáº­t toÃ¡n MiniCache bao gá»“m má»™t sá»‘ bÆ°á»›c quan trá»ng Ä‘á»ƒ Ä‘áº£m báº£o viá»‡c sá»­ dá»¥ng bá»™ nhá»› hiá»‡u quáº£ trong khi duy trÃ¬ tÃ­nh toÃ n váº¹n cá»§a cÃ¡c tráº¡ng thÃ¡i Key-Value (KV) Cache. Ban Ä‘áº§u, cho bá»™ nhá»› Ä‘á»‡m KV E^l_{k,v}, giÃ¡ trá»‹ norm ||X^l_{k,v}||, token chÆ°a há»£p nháº¥t R^l_{k,v}, chá»‰ sá»‘ giá»¯ láº¡i I_{k,v}, vÃ  cÃ¡c token tiáº¿p theo t^l, t^{lâˆ’1}, thuáº­t toÃ¡n tiáº¿n hÃ nh báº±ng cÃ¡ch tÃ¡i Ä‘iá»u chá»‰nh tá»· lá»‡ Ä‘á»™ lá»›n cá»§a cÃ¡c cáº·p KV. Cá»¥ thá»ƒ, XÌ‚^l_k vÃ  XÌ‚^l_v Ä‘Æ°á»£c tÃ­nh báº±ng cÃ¡ch nhÃ¢n cÃ¡c cáº·p KV chuáº©n hÃ³a E^l_{k,v} vá»›i norm Ä‘á»™ lá»›n tÆ°Æ¡ng á»©ng cá»§a chÃºng ||X^l_{k,v}||. Tiáº¿p theo, thuáº­t toÃ¡n khÃ´i phá»¥c cÃ¡c token chÆ°a há»£p nháº¥t báº±ng cÃ¡ch sá»­ dá»¥ng cÃ¡c chá»‰ sá»‘ giá»¯ láº¡i, cáº­p nháº­t XÌ‚^l_k vÃ  XÌ‚^l_v tÆ°Æ¡ng á»©ng. Tiáº¿p theo, cÃ¡c token má»›i t_k vÃ  t_v Ä‘Æ°á»£c ná»‘i vÃ o cÃ¡c cáº·p KV Ä‘Ã£ tÃ¡i Ä‘iá»u chá»‰nh tá»· lá»‡ dá»c theo chiá»u token. Bá»™ nhá»› Ä‘á»‡m KV Ä‘Æ°á»£c tÄƒng cÆ°á»ng nÃ y tráº£i qua cÆ¡ cháº¿ attention softmax trong Ä‘Ã³ Ä‘iá»ƒm attention A Ä‘Æ°á»£c tÃ­nh báº±ng cÃ¡ch láº¥y tÃ­ch vÃ´ hÆ°á»›ng cá»§a token truy váº¥n t_q vá»›i cÃ¡c key Ä‘Æ°á»£c chuyá»ƒn vá»‹ (XÌ‚^l_k)^âŠ¤. Token Ä‘áº§u ra t_O sau Ä‘Ã³ Ä‘Æ°á»£c thu Ä‘Æ°á»£c báº±ng cÃ¡ch nhÃ¢n Ä‘iá»ƒm attention A vá»›i cÃ¡c value XÌ‚^l_v. Trong cÃ¡c trÆ°á»ng há»£p mÃ  token trÆ°á»›c Ä‘Ã³ t^{lâˆ’1} tá»“n táº¡i, thuáº­t toÃ¡n thá»±c hiá»‡n má»™t bÆ°á»›c nÃ©n. NÃ³ ná»‘i bá»™ nhá»› Ä‘á»‡m KV hiá»‡n cÃ³ E^l_{k,v} vá»›i cÃ¡c token Ä‘Ã£ há»£p nháº¥t Ä‘Æ°á»£c táº¡o ra tá»« cÃ¡c lá»›p hiá»‡n táº¡i vÃ  trÆ°á»›c Ä‘Ã³, hiá»‡u quáº£ giáº£m sá»± dÆ° thá»«a vÃ  tá»‘i Æ°u hÃ³a bá»™ nhá»›. Náº¿u t^{lâˆ’1} khÃ´ng cÃ³ sáºµn, bá»™ nhá»› Ä‘á»‡m KV Ä‘Æ°á»£c cáº­p nháº­t báº±ng cÃ¡ch Ä‘Æ¡n giáº£n ná»‘i E^l_{k,v} vá»›i cÃ¡c token má»›i t^l_{k,v}, hoÃ£n viá»‡c nÃ©n cho Ä‘áº¿n láº§n láº·p tiáº¿p theo. Token Ä‘áº§u ra cuá»‘i cÃ¹ng t_O sau Ä‘Ã³ Ä‘Æ°á»£c tráº£ vá», káº¿t thÃºc quÃ¡ trÃ¬nh decoding. Trong hÃ m há»£p nháº¥t, thuáº­t toÃ¡n chuáº©n hÃ³a cÃ¡c cáº·p KV tá»« cáº£ lá»›p hiá»‡n táº¡i vÃ  trÆ°á»›c Ä‘Ã³. NÃ³ tÃ­nh khoáº£ng cÃ¡ch gÃ³c Î© giá»¯a cÃ¡c vector chuáº©n hÃ³a, Ä‘áº£m báº£o ráº±ng viá»‡c ná»™i suy xáº£y ra dá»c theo Ä‘Æ°á»ng dáº«n ngáº¯n nháº¥t trÃªn máº·t cáº§u Ä‘Æ¡n vá»‹. Bá»™ nhá»› Ä‘á»‡m KV Ä‘Ã£ há»£p nháº¥t sau Ä‘Ã³ Ä‘Æ°á»£c thu Ä‘Æ°á»£c báº±ng ná»™i suy cÃ³ trá»ng sá»‘ cá»§a cÃ¡c vector chuáº©n hÃ³a, báº£o tá»“n tÃ­nh toÃ n váº¹n hÃ¬nh há»c vÃ  ngá»¯ nghÄ©a cá»§a cÃ¡c tráº¡ng thÃ¡i gá»‘c. QuÃ¡ trÃ¬nh toÃ n diá»‡n nÃ y cho phÃ©p MiniCache Ä‘áº¡t Ä‘Æ°á»£c hiá»‡u quáº£ bá»™ nhá»› Ä‘Ã¡ng ká»ƒ trong khi duy trÃ¬ cÃ¡c Ä‘áº·c Ä‘iá»ƒm chá»©c nÄƒng cá»§a cÃ¡c cáº·p KV qua cÃ¡c lá»›p transformer.

**HÃ¬nh A:** Tá»•ng quan vá» logic prefilling vÃ  decoding cho MiniCache bao gá»“m viá»‡c thá»±c hiá»‡n há»£p nháº¥t qua lá»›p vÃ  khÃ´i phá»¥c trong khung cá»§a chÃºng tÃ´i.

**Luá»“ng thá»±c thi MiniCache.** HÃ¬nh A mÃ´ táº£ logic pre-filling vÃ  decoding cho khung MiniCache, káº¿t há»£p há»£p nháº¥t qua lá»›p vÃ  á»©c cháº¿ lá»—i Ä‘á»ƒ Ä‘áº¡t Ä‘Æ°á»£c hiá»‡u quáº£ bá»™ nhá»› vÃ  duy trÃ¬ tÃ­nh toÃ n váº¹n chá»©c nÄƒng. Ban Ä‘áº§u, trong BÆ°á»›c 1, bá»™ nhá»› Ä‘á»‡m KV Ä‘Æ°á»£c láº¥y tá»« lá»›p trÆ°á»›c (Layer Lâˆ’1) trong giai Ä‘oáº¡n pre-filling. Trong BÆ°á»›c 2, cÃ¡c cáº·p KV Ä‘Æ°á»£c láº¥y tá»« lá»›p hiá»‡n táº¡i Ï‡^L Ä‘Æ°á»£c há»£p nháº¥t vá»›i cÃ¡c cáº·p KV tá»« lá»›p trÆ°á»›c Ï‡^{Lâˆ’1}, giáº£m sá»± dÆ° thá»«a thÃ´ng qua má»™t

---

hÃ m há»£p nháº¥t. Tiáº¿p theo, trong BÆ°á»›c 3, cÃ¡c cáº·p KV Ä‘Ã£ há»£p nháº¥t Ä‘Æ°á»£c cache Ä‘á»ƒ sá»­ dá»¥ng trong tÆ°Æ¡ng lai, Ä‘áº¡i diá»‡n cho má»™t táº­p dá»¯ liá»‡u há»£p nháº¥t tá»« nhiá»u lá»›p. Trong giai Ä‘oáº¡n decoding, BÆ°á»›c 4 bao gá»“m viá»‡c xÃ³a cÃ¡c cáº·p KV khÃ´ng cáº§n thiáº¿t hoáº·c dÆ° thá»«a Ä‘á»ƒ tá»‘i Æ°u hÃ³a viá»‡c sá»­ dá»¥ng bá»™ nhá»›. Trong BÆ°á»›c 5, decoder láº¥y cÃ¡c cáº·p KV cáº§n thiáº¿t tá»« cache Ä‘á»ƒ táº¡o Ä‘áº§u ra. BÆ°á»›c 6 Ã¡p dá»¥ng cÃ¡c cÆ¡ cháº¿ á»©c cháº¿ lá»—i cho cÃ¡c cáº·p KV Ä‘Ã£ láº¥y, bao gá»“m tÃ¡i Ä‘iá»u chá»‰nh tá»· lá»‡ vÃ  khÃ´i phá»¥c giá»¯ láº¡i, Ä‘á»ƒ giáº£m thiá»ƒu lá»—i Ä‘Æ°á»£c giá»›i thiá»‡u trong quÃ¡ trÃ¬nh há»£p nháº¥t vÃ  nÃ©n. Cuá»‘i cÃ¹ng, trong BÆ°á»›c 7, cache Ä‘Æ°á»£c cáº­p nháº­t vá»›i cÃ¡c cáº·p KV cuá»‘i cÃ¹ng sau á»©c cháº¿ lá»—i vÃ  Ä‘iá»u chá»‰nh, Ä‘áº£m báº£o cache chá»©a biá»ƒu diá»…n chÃ­nh xÃ¡c vÃ  hiá»‡u quáº£ nháº¥t cá»§a cÃ¡c cáº·p KV cho cÃ¡c lá»›p tiáº¿p theo. PhÆ°Æ¡ng phÃ¡p toÃ n diá»‡n nÃ y Ä‘áº£m báº£o hiá»‡u quáº£ bá»™ nhá»› Ä‘Ã¡ng ká»ƒ trong khi báº£o tá»“n cÃ¡c Ä‘áº·c Ä‘iá»ƒm chá»©c nÄƒng quan trá»ng cá»§a cÃ¡c cáº·p KV gá»‘c qua cÃ¡c lá»›p transformer.

**Thuáº­t toÃ¡n 1:** Thuáº­t toÃ¡n Suy luáº­n MiniCache

[Thuáº­t toÃ¡n Ä‘Æ°á»£c giá»¯ nguyÃªn vá»›i cáº¥u trÃºc vÃ  logic tá»« báº£n gá»‘c]

**Thuáº­t toÃ¡n 2:** Thuáº­t toÃ¡n NÃ©n Prefill & Decoding MiniCache

[Thuáº­t toÃ¡n Ä‘Æ°á»£c giá»¯ nguyÃªn vá»›i cáº¥u trÃºc vÃ  logic tá»« báº£n gá»‘c]

### E Dáº«n xuáº¥t Hiá»‡u quáº£ Chi tiáº¿t

Trong pháº§n nÃ y, chÃºng tÃ´i cung cáº¥p dáº«n xuáº¥t chi tiáº¿t vá» cÃ¡c cáº£i thiá»‡n hiá»‡u quáº£ bá»™ nhá»› Ä‘Æ°á»£c nÃªu trong Pháº§n 4.3.

Äáº§u tiÃªn, chÃºng tÃ´i xem xÃ©t viá»‡c sá»­ dá»¥ng bá»™ nhá»› bá»™ nhá»› Ä‘á»‡m KV gá»‘c, Ä‘Æ°á»£c cho bá»Ÿi:
4brh(s+n).

á» Ä‘Ã¢y, r lÃ  sá»‘ lÆ°á»£ng lá»›p, b lÃ  kÃ­ch thÆ°á»›c batch, h lÃ  kÃ­ch thÆ°á»›c áº©n, s lÃ  Ä‘á»™ dÃ i chuá»—i Ä‘áº§u vÃ o, vÃ  n lÃ  Ä‘á»™ dÃ i chuá»—i Ä‘áº§u ra. Äá»ƒ cáº£i thiá»‡n hiá»‡u quáº£, chÃºng tÃ´i báº¯t Ä‘áº§u há»£p nháº¥t cÃ¡c lá»›p tá»« Ä‘iá»ƒm giá»¯a, S = 1/2 r, báº±ng cÃ¡ch há»£p nháº¥t cÃ¡c tráº¡ng thÃ¡i bá»™ nhá»› Ä‘á»‡m KV cá»§a má»—i hai lá»›p thÃ nh má»™t khÃ´ng gian tráº¡ng thÃ¡i chia sáº» duy nháº¥t. Viá»‡c dáº«n xuáº¥t sá»­ dá»¥ng bá»™ nhá»› tiáº¿n hÃ nh nhÆ° sau: cho pháº§n cache chÆ°a há»£p nháº¥t (tá»« lá»›p 1 Ä‘áº¿n S):

---

4brh(s+n) Â· 1/2 = 2brh(s+n).

Cho pháº§n cache Ä‘Ã£ há»£p nháº¥t (tá»« lá»›p S + 1 Ä‘áº¿n r):
4brh(s+n) Â· 1/2 Â· 1/2 = brh(s+n).

Káº¿t há»£p hai pháº§n nÃ y, tá»•ng viá»‡c sá»­ dá»¥ng bá»™ nhá»› lÃ :
2brh(s+n) + brh(s+n) = 3brh(s+n).

Tiáº¿p theo, chÃºng tÃ´i xem xÃ©t chi phÃ­ bá»™ nhá»› bá»• sung phÃ¡t sinh trong quÃ¡ trÃ¬nh khÃ´i phá»¥c. Trong giai Ä‘oáº¡n nÃ y, chÃºng tÃ´i lÆ°u cÃ¡c vector chuáº©n hÃ³a bá»• sung cho cÃ¡c lá»›p trong bá»™ nhá»› Ä‘á»‡m KV. Nhá»¯ng vector nÃ y cÃ³ dáº¡ng R^{bÃ—sÃ—1}, cÃ³ nghÄ©a lÃ  chÃºng cÃ³ má»™t chiá»u kÃªnh duy nháº¥t so vá»›i cÃ¡c tráº¡ng thÃ¡i KV gá»‘c full-rank.

CÃ¡c vector chuáº©n hÃ³a bá»• sung cho cÃ¡c lá»›p tá»« S trá»Ÿ Ä‘i Ä‘Æ°á»£c cho bá»Ÿi:
br(s+n) Â· 2 = 2br(s+n).

ChÃºng tÃ´i cÅ©ng giá»›i thiá»‡u má»™t ngÆ°á»¡ng giá»¯ láº¡i, mÃ  chÃºng tÃ´i Ä‘áº·t thÃ nh 0.05. Äiá»u nÃ y cÃ³ nghÄ©a lÃ  5% token bá»™ nhá»› Ä‘á»‡m KV Ä‘Æ°á»£c giá»¯ láº¡i mÃ  khÃ´ng nÃ©n:
brh(0.05(s+n)).

Káº¿t há»£p cÃ¡c sá»‘ háº¡ng nÃ y, tá»•ng bá»™ nhá»› bá»• sung cho quÃ¡ trÃ¬nh khÃ´i phá»¥c lÃ :
2br(s+n) + 0.1brh(s+n).

Cuá»‘i cÃ¹ng, tá»•ng há»£p viá»‡c sá»­ dá»¥ng bá»™ nhá»› nÃ©n vÃ  chi phÃ­ bá»™ nhá»› khÃ´i phá»¥c, yÃªu cáº§u bá»™ nhá»› tá»•ng thá»ƒ lÃ :
3brh(s+n) + 2br(s+n) + 0.1brh(s+n).

Äiá»u nÃ y cÃ³ thá»ƒ Ä‘Æ°á»£c Ä‘Æ¡n giáº£n hÃ³a báº±ng cÃ¡ch nhÃ³m cÃ¡c yáº¿u tá»‘ chung:
br(s+n)(3h + 2 + 0.1h).

ÄÆ¡n giáº£n hÃ³a biá»ƒu thá»©c bÃªn trong dáº¥u ngoáº·c, chÃºng ta cÃ³:
br(s+n)(3.1h + 2).

Do Ä‘Ã³, tá»•ng chi phÃ­ bá»™ nhá»› cho bá»™ nhá»› Ä‘á»‡m KV trong Khung MiniCache lÃ :
br(s+n)(3.1h + 2).

Viá»‡c dáº«n xuáº¥t chi tiáº¿t nÃ y xÃ¡c nháº­n cÃ¡c cáº£i thiá»‡n hiá»‡u quáº£ Ä‘Æ°á»£c tháº£o luáº­n trong Pháº§n 4.3, nÃªu báº­t viá»‡c giáº£m Ä‘Ã¡ng ká»ƒ viá»‡c sá»­ dá»¥ng bá»™ nhá»› Ä‘áº¡t Ä‘Æ°á»£c thÃ´ng qua cÃ¡c chiáº¿n lÆ°á»£c há»£p nháº¥t lá»›p vÃ  khÃ´i phá»¥c cá»§a chÃºng tÃ´i.

### F Káº¿t quáº£ ThÃ­ nghiá»‡m Chi tiáº¿t

[CÃ¡c báº£ng tá»« B Ä‘áº¿n M Ä‘Æ°á»£c giá»¯ nguyÃªn vá»›i dá»¯ liá»‡u chi tiáº¿t vá» hiá»‡u nÄƒng so sÃ¡nh trÃªn cÃ¡c bá»™ dá»¯ liá»‡u GSM8K, COQA, vÃ  TruthfulQA vá»›i cÃ¡c mÃ´ hÃ¬nh khÃ¡c nhau]
